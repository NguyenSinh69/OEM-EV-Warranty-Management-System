_format_version: "3.0"
_transform: true

services:
  # Customer Service
  - name: customer-service
    url: http://customer-service:8001
    tags: ["evm", "customer"]

  # Warranty Service
  - name: warranty-service
    url: http://warranty-service:8002
    tags: ["evm", "warranty"]

  # Vehicle Service
  - name: vehicle-service
    url: http://vehicle-service:8003
    tags: ["evm", "vehicle"]

  # Admin Service
  - name: admin-service
    url: http://admin-service:8004
    tags: ["evm", "admin"]

  # Notification Service
  - name: notification-service
    url: http://notification-service:8005
    tags: ["evm", "notification"]

routes:
  # Health check
  - name: health-check
    service: customer-service
    paths: ["/api/health"]
    methods: ["GET", "OPTIONS"]
    strip_path: false

  # ===== Customer Service (giữ nguyên) =====
  - name: customer-routes
    service: customer-service
    paths: ["/api/customers"]
    methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    strip_path: false

  - name: customer-auth
    service: customer-service
    paths: ["/api/auth"]
    methods: ["GET", "POST", "OPTIONS"]
    strip_path: false

  # ===== Warranty Service (Ticket #34) =====
  # List + Create claims: /api/customer/claims
  - name: warranty-customer-claims
    service: warranty-service
    paths: ["/api/customer/claims"]
    methods: ["GET", "POST", "OPTIONS"]
    strip_path: false

  # Detail + Upload: prefix /api/customer/claims/{id}[...]
  - name: warranty-customer-claims-detail
    service: warranty-service
    paths: ["/api/customer/claims/"]
    methods: ["GET", "POST", "OPTIONS"]
    strip_path: false

  # ===== Vehicle Service (Ticket #34) =====
  # Vehicles for dashboard: /api/customer/vehicles?ownerId=...
  - name: vehicle-customer-vehicles
    service: vehicle-service
    paths: ["/api/customer/vehicles"]
    methods: ["GET", "OPTIONS"]
    strip_path: false

  # ===== Admin Service (giữ nguyên) =====
  - name: admin-routes
    service: admin-service
    paths: ["/api/admin"]
    methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    strip_path: false

  - name: admin-policies
    service: admin-service
    paths: ["/api/policies"]
    methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    strip_path: false

  # ===== Notification Service (giữ nguyên) =====
  - name: notification-routes
    service: notification-service
    paths: ["/api/notifications"]
    methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    strip_path: false

plugins:
  # ===== CORS (global) =====
  - name: cors
    config:
      origins: ["*"]
      methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
      headers: ["Accept", "Accept-Version", "Content-Length", "Content-MD5", "Content-Type", "Date", "X-Auth-Token", "Authorization"]
      exposed_headers: ["X-Auth-Token"]
      credentials: true
      max_age: 3600

  # ===== Rate Limiting (global) =====
  - name: rate-limiting
    config:
      minute: 100
      hour: 1000
      day: 10000

  # ===== Request Size Limiting (global) =====
  # Tăng lên 50MB để upload ảnh/tài liệu
  - name: request-size-limiting
    config:
      allowed_payload_size: 50

  # ===== JWT cho các route mới (Ticket #34) =====
  - name: jwt
    route: warranty-customer-claims
    config:
      header_names: ["Authorization"]
      claims_to_verify: ["exp"]
      run_on_preflight: false

  - name: jwt
    route: warranty-customer-claims-detail
    config:
      header_names: ["Authorization"]
      claims_to_verify: ["exp"]
      run_on_preflight: false

  - name: jwt
    route: vehicle-customer-vehicles
    config:
      header_names: ["Authorization"]
      claims_to_verify: ["exp"]
      run_on_preflight: false

  # ===== JWT (các route cũ giữ nguyên) =====
  - name: jwt
    route: customer-routes
    config:
      header_names: ["Authorization"]
      claims_to_verify: ["exp"]
      run_on_preflight: false

  - name: jwt
    route: admin-routes
    config:
      header_names: ["Authorization"]
      claims_to_verify: ["exp"]
      run_on_preflight: false

  - name: jwt
    route: notification-routes
    config:
      header_names: ["Authorization"]
      claims_to_verify: ["exp"]
      run_on_preflight: false

consumers:
  - username: evm-admin
    custom_id: admin-001

  - username: evm-customer
    custom_id: customer-001

  - username: evm-staff
    custom_id: staff-001

jwt_secrets:
  - consumer: evm-admin
    key: admin-jwt-key
    secret: "your-admin-jwt-secret-key-here"

  - consumer: evm-customer
    key: customer-jwt-key
    secret: "your-customer-jwt-secret-key-here"

  - consumer: evm-staff
    key: staff-jwt-key
    secret: "your-staff-jwt-secret-key-here"
