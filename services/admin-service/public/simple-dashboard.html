<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard - OEM EV Warranty</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .sidebar {
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        margin: 2px 0;
      }
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }
      .main-content {
        background: #f8f9fa;
        min-height: 100vh;
      }
      .stat-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .stat-card:hover {
        transform: translateY(-2px);
      }
      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
      }

      /* Report Styles */
      .report-header {
        border-bottom: 3px solid #667eea;
        padding-bottom: 1rem;
        margin-bottom: 2rem;
      }

      .report-section {
        margin-bottom: 2rem;
        page-break-inside: avoid;
      }

      .progress-bar {
        transition: width 0.5s ease-in-out;
      }

      @media print {
        .modal-footer,
        .btn {
          display: none !important;
        }

        .modal-dialog {
          max-width: 100% !important;
          margin: 0 !important;
        }

        .modal-content {
          border: none !important;
          box-shadow: none !important;
        }

        body {
          background: white !important;
        }
      }

      .analytics-card {
        transition: all 0.3s ease;
        border-left: 4px solid #667eea;
      }

      .analytics-card:hover {
        border-left-color: #764ba2;
        transform: translateX(2px);
      }

      .metric-icon {
        font-size: 2rem;
        opacity: 0.7;
      }

      .trend-up {
        color: #28a745;
      }

      .trend-down {
        color: #dc3545;
      }

      .trend-stable {
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar p-3">
          <div class="text-center mb-4">
            <h4>üöó OEM EV Warranty</h4>
            <small id="welcomeMessage">Ch√†o m·ª´ng!</small>
          </div>

          <ul class="nav flex-column">
            <li class="nav-item">
              <a
                class="nav-link active"
                href="#dashboard"
                onclick="showSection('dashboard')"
              >
                üìä Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#users" onclick="showSection('users')">
                üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng
              </a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="#settings"
                onclick="showSection('settings')"
              >
                ‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng
              </a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="#reports"
                onclick="showSection('reports')"
              >
                üìà B√°o c√°o & Ph√¢n t√≠ch
              </a>
            </li>
          </ul>

          <div class="mt-auto pt-3">
            <a href="simple-login.html" class="nav-link"> üö™ ƒêƒÉng xu·∫•t </a>
          </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          >
            <h1 class="h2" id="pageTitle">Dashboard</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary">
                  üìÑ Export
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-secondary"
                  onclick="updateDashboardStats()"
                >
                  üîÑ Refresh
                </button>
              </div>
            </div>
          </div>

          <!-- Dashboard Section -->
          <div id="dashboard-section" class="content-section">
            <div class="row mb-4">
              <div class="col-md-3 mb-3">
                <div class="stat-card">
                  <div class="stat-number">1</div>
                  <div class="text-muted">T·ªïng ng∆∞·ªùi d√πng</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="stat-card">
                  <div class="stat-number">23</div>
                  <div class="text-muted">Trung t√¢m d·ªãch v·ª•</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="stat-card">
                  <div class="stat-number">14</div>
                  <div class="text-muted">Y√™u c·∫ßu b·∫£o h√†nh</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="stat-card">
                  <div class="stat-number">98%</div>
                  <div class="text-muted">T·ª∑ l·ªá ho√†n th√†nh</div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-8">
                <div class="card">
                  <div class="card-header">
                    <h5>üìä Bi·ªÉu ƒë·ªì th·ªëng k√™</h5>
                  </div>
                  <div class="card-body">
                    <canvas id="chartCanvas" width="400" height="200"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <div class="card-header">
                    <h5>üìã Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h5>
                  </div>
                  <div class="card-body">
                    <div class="list-group list-group-flush">
                      <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                          <h6 class="mb-1">Ng∆∞·ªùi d√πng m·ªõi ƒëƒÉng k√Ω</h6>
                          <small>3 ph√∫t tr∆∞·ªõc</small>
                        </div>
                        <p class="mb-1">user123 ƒë√£ t·∫°o t√†i kho·∫£n m·ªõi</p>
                      </div>
                      <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                          <h6 class="mb-1">Y√™u c·∫ßu b·∫£o h√†nh m·ªõi</h6>
                          <small class="text-muted">15 ph√∫t tr∆∞·ªõc</small>
                        </div>
                        <p class="mb-1">Y√™u c·∫ßu #WR-2024-001 ƒë√£ ƒë∆∞·ª£c t·∫°o</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Users Section -->
          <div id="users-section" class="content-section" style="display: none">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h3>üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h3>
                <small class="text-muted">
                  <span id="dataInfo" class="badge bg-success ms-1"
                    >Database Ready</span
                  >
                </small>
              </div>
              <div class="btn-group">
                <button class="btn btn-success" onclick="showAddUserModal()">
                  ‚ûï Th√™m ng∆∞·ªùi d√πng
                </button>
                <button class="btn btn-primary" onclick="loadUsers()">
                  üîÑ T·∫£i danh s√°ch
                </button>
                <button
                  class="btn btn-outline-secondary btn-sm"
                  onclick="downloadBackup()"
                  title="T·∫£i xu·ªëng backup d·ªØ li·ªáu"
                >
                  üì• Backup
                </button>
              </div>
            </div>

            <div class="card">
              <div class="card-body">
                <div id="usersTable">
                  <p class="text-center text-muted">
                    <i class="fas fa-users fa-3x mb-3"></i><br />
                    Nh·∫•n "T·∫£i danh s√°ch" ƒë·ªÉ xem ng∆∞·ªùi d√πng ho·∫∑c "Th√™m ng∆∞·ªùi
                    d√πng" ƒë·ªÉ t·∫°o m·ªõi
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Add User Modal -->
          <div
            class="modal fade"
            id="addUserModal"
            tabindex="-1"
            aria-labelledby="addUserModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="addUserModalLabel">
                    ‚ûï Th√™m ng∆∞·ªùi d√πng m·ªõi
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <form id="addUserForm">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="newUsername" class="form-label"
                            >T√™n ƒëƒÉng nh·∫≠p *</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="newUsername"
                            required
                            minlength="3"
                            maxlength="50"
                          />
                          <div class="form-text">
                            T·ªëi thi·ªÉu 3 k√Ω t·ª±, ch·ªâ ch·ª©a ch·ªØ v√† s·ªë
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="newEmail" class="form-label">Email</label>
                          <input
                            type="email"
                            class="form-control"
                            id="newEmail"
                          />
                          <div class="form-text">Email li√™n h·ªá (t√πy ch·ªçn)</div>
                        </div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="newPassword" class="form-label"
                            >M·∫≠t kh·∫©u *</label
                          >
                          <input
                            type="password"
                            class="form-control"
                            id="newPassword"
                            required
                            minlength="6"
                          />
                          <div class="form-text">T·ªëi thi·ªÉu 6 k√Ω t·ª±</div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="newRole" class="form-label"
                            >Vai tr√≤ *</label
                          >
                          <select class="form-select" id="newRole" required>
                            <option value="">-- Ch·ªçn vai tr√≤ --</option>
                            <option value="Admin">üîë Qu·∫£n tr·ªã vi√™n</option>
                            <option value="EVM_Staff">üè¢ Nh√¢n vi√™n EVM</option>
                            <option value="SC_Staff">
                              üîß Nh√¢n vi√™n trung t√¢m d·ªãch v·ª•
                            </option>
                            <option value="SC_Technician">
                              ‚öôÔ∏è K·ªπ thu·∫≠t vi√™n
                            </option>
                          </select>
                        </div>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label for="newNote" class="form-label">Ghi ch√∫</label>
                      <textarea
                        class="form-control"
                        id="newNote"
                        rows="2"
                        placeholder="Th√™m ghi ch√∫ v·ªÅ ng∆∞·ªùi d√πng n√†y..."
                      ></textarea>
                    </div>

                    <div id="addUserMessage"></div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    ‚ùå H·ªßy
                  </button>
                  <button
                    type="button"
                    class="btn btn-success"
                    onclick="addUser()"
                  >
                    <span id="addUserText">üíæ T·∫°o ng∆∞·ªùi d√πng</span>
                    <span
                      id="addUserSpinner"
                      class="spinner-border spinner-border-sm d-none ms-2"
                    ></span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- View User Modal -->
          <div
            class="modal fade"
            id="viewUserModal"
            tabindex="-1"
            aria-labelledby="viewUserModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="viewUserModalLabel">
                    üë§ Th√¥ng tin chi ti·∫øt ng∆∞·ªùi d√πng
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <div id="userDetails">
                    <p class="text-center">Loading...</p>
                  </div>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    ƒê√≥ng
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="editCurrentUser()"
                  >
                    ‚úèÔ∏è Ch·ªânh s·ª≠a
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Edit User Modal -->
          <div
            class="modal fade"
            id="editUserModal"
            tabindex="-1"
            aria-labelledby="editUserModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="editUserModalLabel">
                    ‚úèÔ∏è Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <div id="editUserMessage"></div>
                  <form id="editUserForm">
                    <input type="hidden" id="editUserId" />
                    <div class="mb-3">
                      <label for="editUsername" class="form-label"
                        >T√™n ƒëƒÉng nh·∫≠p</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="editUsername"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label for="editUserRole" class="form-label"
                        >Vai tr√≤</label
                      >
                      <select class="form-select" id="editUserRole" required>
                        <option value="">Ch·ªçn vai tr√≤...</option>
                        <option value="Admin">Admin</option>
                        <option value="EVM_Staff">EVM Staff</option>
                        <option value="SC_Staff">SC Staff</option>
                        <option value="SC_Technician">SC Technician</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="editUserEmail" class="form-label"
                        >Email</label
                      >
                      <input
                        type="email"
                        class="form-control"
                        id="editUserEmail"
                      />
                    </div>
                    <div class="mb-3">
                      <label for="editUserNote" class="form-label"
                        >Ghi ch√∫</label
                      >
                      <textarea
                        class="form-control"
                        id="editUserNote"
                        rows="2"
                      ></textarea>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    H·ªßy
                  </button>
                  <button
                    type="button"
                    class="btn btn-success"
                    onclick="updateUser()"
                  >
                    <span id="editUserText">üíæ C·∫≠p nh·∫≠t</span>
                    <div
                      id="editUserSpinner"
                      class="spinner-border spinner-border-sm ms-2"
                      style="display: none"
                      role="status"
                    >
                      <span class="visually-hidden">ƒêang x·ª≠ l√Ω...</span>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Settings Section -->
          <div
            id="settings-section"
            class="content-section"
            style="display: none"
          >
            <h3>‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</h3>
            <div class="card">
              <div class="card-body">
                <h5>C·∫•u h√¨nh chung</h5>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">T√™n h·ªá th·ªëng</label>
                      <input
                        type="text"
                        class="form-control"
                        value="OEM EV Warranty Management"
                      />
                    </div>
                    <div class="form-group mb-3">
                      <label class="form-label">Email h·ªó tr·ª£</label>
                      <input
                        type="email"
                        class="form-control"
                        value="support@oemev.com"
                      />
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">M√∫i gi·ªù</label>
                      <select class="form-select">
                        <option selected>UTC+7 (Vietnam)</option>
                        <option>UTC+0 (GMT)</option>
                      </select>
                    </div>
                    <div class="form-group mb-3">
                      <label class="form-label">Ng√¥n ng·ªØ</label>
                      <select class="form-select">
                        <option selected>Ti·∫øng Vi·ªát</option>
                        <option>English</option>
                      </select>
                    </div>
                  </div>
                </div>
                <button class="btn btn-success">üíæ L∆∞u c√†i ƒë·∫∑t</button>
              </div>
            </div>
          </div>

          <!-- Reports Section -->
          <div
            id="reports-section"
            class="content-section"
            style="display: none"
          >
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3>üìà B√°o c√°o & Ph√¢n t√≠ch</h3>
              <div class="btn-group">
                <button
                  class="btn btn-outline-primary"
                  onclick="refreshReports()"
                >
                  üîÑ C·∫≠p nh·∫≠t
                </button>
                <button class="btn btn-success" onclick="exportAllReports()">
                  üìä Xu·∫•t t·∫•t c·∫£ b√°o c√°o
                </button>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="card">
                  <div
                    class="card-header d-flex justify-content-between align-items-center"
                  >
                    <h5>üìä B√°o c√°o ng∆∞·ªùi d√πng</h5>
                    <span class="badge bg-primary" id="totalUsersCount">0</span>
                  </div>
                  <div class="card-body">
                    <p>Th·ªëng k√™ ng∆∞·ªùi d√πng theo vai tr√≤:</p>
                    <ul id="userRoleStats">
                      <li>
                        Admin: <span class="fw-bold text-danger">0</span> ng∆∞·ªùi
                      </li>
                      <li>
                        EVM Staff:
                        <span class="fw-bold text-info">0</span> ng∆∞·ªùi
                      </li>
                      <li>
                        SC Staff:
                        <span class="fw-bold text-warning">0</span> ng∆∞·ªùi
                      </li>
                      <li>
                        Technician:
                        <span class="fw-bold text-success">0</span> ng∆∞·ªùi
                      </li>
                    </ul>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                      <button
                        class="btn btn-primary btn-sm"
                        onclick="exportUserReport()"
                      >
                        üìÑ Xu·∫•t b√°o c√°o Excel
                      </button>
                      <button
                        class="btn btn-info btn-sm"
                        onclick="showUserDetails()"
                      >
                        üëÅÔ∏è Xem chi ti·∫øt
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div
                    class="card-header d-flex justify-content-between align-items-center"
                  >
                    <h5>üîß B√°o c√°o b·∫£o h√†nh</h5>
                    <span class="badge bg-success" id="totalWarrantiesCount"
                      >0</span
                    >
                  </div>
                  <div class="card-body">
                    <p>Th·ªëng k√™ y√™u c·∫ßu b·∫£o h√†nh:</p>
                    <ul id="warrantyStats">
                      <li>
                        ƒêang x·ª≠ l√Ω:
                        <span class="fw-bold text-warning">0</span> y√™u c·∫ßu
                      </li>
                      <li>
                        Ho√†n th√†nh:
                        <span class="fw-bold text-success">0</span> y√™u c·∫ßu
                      </li>
                      <li>
                        ƒê√£ h·ªßy: <span class="fw-bold text-danger">0</span> y√™u
                        c·∫ßu
                      </li>
                      <li>
                        T·ª∑ l·ªá th√†nh c√¥ng:
                        <span class="fw-bold text-primary">0%</span>
                      </li>
                    </ul>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                      <button
                        class="btn btn-success btn-sm"
                        onclick="exportWarrantyPDFReport()"
                      >
                        üìä Xu·∫•t b√°o c√°o PDF
                      </button>
                      <button
                        class="btn btn-primary btn-sm"
                        onclick="exportWarrantyReport()"
                      >
                        üìÑ Xu·∫•t b√°o c√°o Excel
                      </button>
                      <button
                        class="btn btn-warning btn-sm"
                        onclick="showWarrantyDetails()"
                      >
                        üîç Xem chi ti·∫øt
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Advanced Analytics -->
            <div class="row mt-4">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header">
                    <h5>üìà Ph√¢n t√≠ch n√¢ng cao</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-4">
                        <div class="text-center p-3 border rounded">
                          <h4 class="text-primary" id="avgProcessingTime">0</h4>
                          <small class="text-muted"
                            >Th·ªùi gian x·ª≠ l√Ω TB (gi·ªù)</small
                          >
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="text-center p-3 border rounded">
                          <h4 class="text-success" id="customerSatisfaction">
                            0%
                          </h4>
                          <small class="text-muted">M·ª©c ƒë·ªô h√†i l√≤ng</small>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="text-center p-3 border rounded">
                          <h4 class="text-warning" id="monthlyCosts">$0</h4>
                          <small class="text-muted">Chi ph√≠ h√†ng th√°ng</small>
                        </div>
                      </div>
                    </div>
                    <div class="mt-3 text-center">
                      <button
                        class="btn btn-outline-primary me-2"
                        onclick="generateAdvancedReport()"
                      >
                        üìä T·∫°o b√°o c√°o chi ti·∫øt
                      </button>
                      <button
                        class="btn btn-outline-success"
                        onclick="exportAnalytics()"
                      >
                        üìà Xu·∫•t ph√¢n t√≠ch
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- User Details Modal -->
    <div
      class="modal fade"
      id="userDetailsModal"
      tabindex="-1"
      aria-labelledby="userDetailsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="userDetailsModalLabel">
              üë• Chi ti·∫øt b√°o c√°o ng∆∞·ªùi d√πng
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="userDetailsContent">
              <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">ƒêang t·∫£i...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ƒê√≥ng
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="exportUserDetailReport()"
            >
              üìÑ Xu·∫•t Excel
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Warranty Details Modal -->
    <div
      class="modal fade"
      id="warrantyDetailsModal"
      tabindex="-1"
      aria-labelledby="warrantyDetailsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="warrantyDetailsModalLabel">
              üîß Chi ti·∫øt b√°o c√°o b·∫£o h√†nh
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div id="warrantyDetailsContent">
              <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">ƒêang t·∫£i...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ƒê√≥ng
            </button>
            <button
              type="button"
              class="btn btn-success"
              onclick="exportWarrantyDetailReport()"
            >
              üìä Xu·∫•t PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Advanced Report Modal -->
    <div
      class="modal fade"
      id="advancedReportModal"
      tabindex="-1"
      aria-labelledby="advancedReportModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="advancedReportModalLabel">
              üìà B√°o c√°o chi ti·∫øt v√† ph√¢n t√≠ch
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" style="max-height: 70vh; overflow-y: auto">
            <div id="advancedReportContent">
              <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">ƒêang t·∫°o b√°o c√°o...</span>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ƒê√≥ng
            </button>
            <button
              type="button"
              class="btn btn-outline-primary"
              onclick="printReport()"
            >
              üñ®Ô∏è In b√°o c√°o
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="exportAdvancedReportPDF()"
            >
              üìÑ Xu·∫•t PDF
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      function showSection(sectionName) {
        // Hide all sections
        const sections = document.querySelectorAll(".content-section");
        sections.forEach((section) => (section.style.display = "none"));

        // Show selected section
        document.getElementById(sectionName + "-section").style.display =
          "block";

        // Update page title
        const titles = {
          dashboard: "Dashboard",
          users: "Qu·∫£n l√Ω ng∆∞·ªùi d√πng",
          settings: "C√†i ƒë·∫∑t h·ªá th·ªëng",
          reports: "B√°o c√°o & Ph√¢n t√≠ch",
        };
        document.getElementById("pageTitle").textContent = titles[sectionName];

        // Update active nav link
        const navLinks = document.querySelectorAll(".nav-link");
        navLinks.forEach((link) => link.classList.remove("active"));
        event.target.classList.add("active");
      }

      async function loadUsers() {
        const usersTable = document.getElementById("usersTable");
        usersTable.innerHTML = '<p class="text-center">üîÑ ƒêang t·∫£i...</p>';

        try {
          const response = await fetch("simple-api.php/api/users");
          const result = await response.json();

          if (result.success) {
            let tableHtml = `
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>T√™n ƒëƒÉng nh·∫≠p</th>
                                    <th>Vai tr√≤</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

            result.data.forEach((user) => {
              tableHtml += `
                            <tr>
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td><span class="badge bg-primary">${user.role}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info me-1" onclick="viewUser(${user.id}, '${user.username}', '${user.role}')">üëÅÔ∏è Xem</button>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser(${user.id})">‚úèÔ∏è S·ª≠a</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id}, '${user.username}')">üóëÔ∏è X√≥a</button>
                                </td>
                            </tr>
                        `;
            });

            tableHtml += "</tbody></table>";

            // Add data source info
            if (result.source) {
              tableHtml += `<div class="mt-3 text-end">
                <small class="text-muted">
                  üìä T·ªïng: ${result.total} ng∆∞·ªùi d√πng | 
                  üíæ Ngu·ªìn: ${
                    result.source === "file_storage"
                      ? "File JSON (L∆∞u vƒ©nh vi·ªÖn)"
                      : "Session (T·∫°m th·ªùi)"
                  }
                </small>
              </div>`;
            }

            usersTable.innerHTML = tableHtml;

            // Update data info badge
            const dataInfoBadge = document.getElementById("dataInfo");
            if (dataInfoBadge) {
              if (result.source === "file_storage") {
                dataInfoBadge.className = "badge bg-success ms-1";
                dataInfoBadge.textContent = `${result.total} users stored`;
              } else {
                dataInfoBadge.className = "badge bg-warning ms-1";
                dataInfoBadge.textContent = "Temporary storage";
              }
            }

            // Update dashboard stats after loading users
            updateDashboardStats();
          } else {
            usersTable.innerHTML =
              '<p class="text-danger">‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng</p>';
          }
        } catch (err) {
          console.error("Load users error:", err);
          usersTable.innerHTML = '<p class="text-danger">‚ùå L·ªói k·∫øt n·ªëi</p>';
        }
      }

      // Check session and update welcome message
      async function checkSession() {
        try {
          const response = await fetch("simple-api.php/api/test");
          const result = await response.json();

          if (result.session) {
            document.getElementById(
              "welcomeMessage"
            ).textContent = `Ch√†o ${result.session.username}!`;
          }
        } catch (err) {
          console.error("Session check failed:", err);
        }
      }

      // Show Add User Modal
      function showAddUserModal() {
        // Reset form
        document.getElementById("addUserForm").reset();
        document.getElementById("addUserMessage").innerHTML = "";

        // Show modal
        const modal = new bootstrap.Modal(
          document.getElementById("addUserModal")
        );
        modal.show();

        // Focus on username field
        setTimeout(() => {
          document.getElementById("newUsername").focus();
        }, 500);
      }

      // Add User Function
      async function addUser() {
        const username = document.getElementById("newUsername").value.trim();
        const email = document.getElementById("newEmail").value.trim();
        const password = document.getElementById("newPassword").value.trim();
        const role = document.getElementById("newRole").value;
        const note = document.getElementById("newNote").value.trim();

        // Validation
        if (!username || username.length < 3) {
          showAddUserMessage("T√™n ƒëƒÉng nh·∫≠p ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±", "danger");
          return;
        }

        if (!password || password.length < 6) {
          showAddUserMessage("M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±", "danger");
          return;
        }

        if (!role) {
          showAddUserMessage("Vui l√≤ng ch·ªçn vai tr√≤", "danger");
          return;
        }

        // Set loading state
        setAddUserLoading(true);

        try {
          const userData = {
            username: username,
            password: password,
            role: role,
            email: email || null,
            note: note || null,
          };

          const response = await fetch("simple-api.php/api/users", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(userData),
          });

          const result = await response.json();

          if (result.success) {
            showAddUserMessage("‚úÖ T·∫°o ng∆∞·ªùi d√πng th√†nh c√¥ng!", "success");

            // Show success notification on main page
            showMainNotification(
              `‚úÖ ƒê√£ th√™m ng∆∞·ªùi d√πng "${username}" th√†nh c√¥ng!`,
              "success"
            );

            // Reload users immediately
            setTimeout(() => {
              loadUsers();
            }, 500);

            // Close modal after 2 seconds
            setTimeout(() => {
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addUserModal")
              );
              if (modal) {
                modal.hide();
              }
            }, 2000);
          } else {
            showAddUserMessage(
              result.error || "Kh√¥ng th·ªÉ t·∫°o ng∆∞·ªùi d√πng",
              "danger"
            );
          }
        } catch (err) {
          console.error("Add user error:", err);
          showAddUserMessage("‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.", "danger");
        } finally {
          setAddUserLoading(false);
        }
      }

      // View User Function
      function viewUser(id, username, role) {
        const userDetailsDiv = document.getElementById("userDetails");

        // Generate user details HTML
        userDetailsDiv.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <div class="card border-0 bg-light">
                <div class="card-body">
                  <h6 class="card-title text-primary">üÜî Th√¥ng tin c∆° b·∫£n</h6>
                  <p><strong>ID:</strong> ${id}</p>
                  <p><strong>T√™n ƒëƒÉng nh·∫≠p:</strong> ${username}</p>
                  <p><strong>Vai tr√≤:</strong> <span class="badge bg-primary">${role}</span></p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-0 bg-light">
                <div class="card-body">
                  <h6 class="card-title text-success">üìä Th·ªëng k√™ ho·∫°t ƒë·ªông</h6>
                  <p><strong>Ng√†y t·∫°o:</strong> ${new Date().toLocaleDateString(
                    "vi-VN"
                  )}</p>
                  <p><strong>L·∫ßn ƒëƒÉng nh·∫≠p cu·ªëi:</strong> H√¥m nay</p>
                  <p><strong>Tr·∫°ng th√°i:</strong> <span class="badge bg-success">Ho·∫°t ƒë·ªông</span></p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-12">
              <div class="card border-0 bg-light">
                <div class="card-body">
                  <h6 class="card-title text-info">üîí Quy·ªÅn h·∫°n</h6>
                  <div class="row">
                    ${getRolePermissions(role)}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        // Show modal
        const modal = new bootstrap.Modal(
          document.getElementById("viewUserModal")
        );
        modal.show();
      }

      // Get role permissions HTML
      function getRolePermissions(role) {
        const permissions = {
          Admin: [
            "üëë Qu·∫£n tr·ªã to√†n h·ªá th·ªëng",
            "üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng",
            "‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng",
            "üìä Xem b√°o c√°o",
          ],
          EVM_Staff: [
            "üìã Qu·∫£n l√Ω y√™u c·∫ßu b·∫£o h√†nh",
            "üìä Xem b√°o c√°o",
            "üìû H·ªó tr·ª£ kh√°ch h√†ng",
          ],
          SC_Staff: [
            "üîß X·ª≠ l√Ω y√™u c·∫ßu b·∫£o h√†nh",
            "üìù C·∫≠p nh·∫≠t tr·∫°ng th√°i",
            "üë• Qu·∫£n l√Ω k·ªπ thu·∫≠t vi√™n",
          ],
          SC_Technician: [
            "‚öôÔ∏è Th·ª±c hi·ªán s·ª≠a ch·ªØa",
            "üìù C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô",
            "üì∑ T·∫£i l√™n h√¨nh ·∫£nh",
          ],
        };

        const userPermissions = permissions[role] || [
          "Kh√¥ng c√≥ quy·ªÅn ƒë·∫∑c bi·ªát",
        ];

        return userPermissions
          .map(
            (permission) =>
              `<div class="col-md-6 mb-2">
            <span class="badge bg-outline-secondary">${permission}</span>
          </div>`
          )
          .join("");
      }

      // Edit User Function
      // Edit User Function
      async function editUser(id) {
        try {
          // Load current users to find the user data
          const response = await fetch("simple-api.php/api/users");
          const result = await response.json();

          if (result.success) {
            const user = result.data.find((u) => u.id == id);
            if (user) {
              // Fill the edit form with current user data
              document.getElementById("editUserId").value = user.id;
              document.getElementById("editUsername").value = user.username;
              document.getElementById("editUserRole").value = user.role;
              document.getElementById("editUserEmail").value = user.email || "";
              document.getElementById("editUserNote").value = user.note || "";

              // Clear any previous messages
              document.getElementById("editUserMessage").innerHTML = "";

              // Show the modal
              const editModal = new bootstrap.Modal(
                document.getElementById("editUserModal")
              );
              editModal.show();
            } else {
              showMainNotification("‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng", "danger");
            }
          }
        } catch (err) {
          console.error("Load user error:", err);
          showMainNotification("‚ùå L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng", "danger");
        }
      }

      // Delete User Function
      async function deleteUser(id, username) {
        if (
          confirm(
            `‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng "${username}"?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`
          )
        ) {
          try {
            const response = await fetch(`simple-api.php/api/users/${id}`, {
              method: "DELETE",
            });
            const result = await response.json();

            if (result.success) {
              showMainNotification(`‚úÖ ${result.message}`, "success");

              // Reload users list
              setTimeout(() => {
                loadUsers();
              }, 500);
            } else {
              showMainNotification(
                `‚ùå ${result.error || "Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng"}`,
                "danger"
              );
            }
          } catch (err) {
            console.error("Delete user error:", err);
            showMainNotification("‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.", "danger");
          }
        }
      }

      // Update User Function
      async function updateUser() {
        const userId = document.getElementById("editUserId").value;
        const username = document.getElementById("editUsername").value.trim();
        const role = document.getElementById("editUserRole").value;
        const email = document.getElementById("editUserEmail").value.trim();
        const note = document.getElementById("editUserNote").value.trim();

        // Clear previous messages
        document.getElementById("editUserMessage").innerHTML = "";

        // Validate input
        if (!username) {
          showEditUserMessage("Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p", "danger");
          return;
        }
        if (!role) {
          showEditUserMessage("Vui l√≤ng ch·ªçn vai tr√≤", "danger");
          return;
        }

        setEditUserLoading(true);

        try {
          const response = await fetch(`simple-api.php/api/users/${userId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: username,
              role: role,
              email: email,
              note: note,
            }),
          });

          const result = await response.json();

          if (result.success) {
            showEditUserMessage(`‚úÖ ${result.message}`, "success");

            // Reload users after delay
            setTimeout(() => {
              loadUsers();
            }, 500);

            // Close modal after 2 seconds
            setTimeout(() => {
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("editUserModal")
              );
              if (modal) {
                modal.hide();
              }
            }, 2000);
          } else {
            showEditUserMessage(
              result.error || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng",
              "danger"
            );
          }
        } catch (err) {
          console.error("Update user error:", err);
          showEditUserMessage("‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.", "danger");
        } finally {
          setEditUserLoading(false);
        }
      }

      // Helper functions for Edit User Modal
      function showEditUserMessage(message, type = "danger") {
        const msgDiv = document.getElementById("editUserMessage");
        msgDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      }

      function setEditUserLoading(loading) {
        const button = document.querySelector("#editUserModal .btn-success");
        const text = document.getElementById("editUserText");
        const spinner = document.getElementById("editUserSpinner");

        if (loading) {
          button.disabled = true;
          text.textContent = "ƒêang x·ª≠ l√Ω...";
          spinner.style.display = "inline-block";
        } else {
          button.disabled = false;
          text.textContent = "üíæ C·∫≠p nh·∫≠t";
          spinner.style.display = "none";
        }
      }

      // Helper functions for Add User Modal
      function showAddUserMessage(message, type = "danger") {
        const msgDiv = document.getElementById("addUserMessage");
        msgDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      }

      function setAddUserLoading(loading) {
        const button = document.querySelector("#addUserModal .btn-success");
        const text = document.getElementById("addUserText");
        const spinner = document.getElementById("addUserSpinner");

        if (loading) {
          button.disabled = true;
          text.textContent = "‚è≥ ƒêang t·∫°o...";
          spinner.classList.remove("d-none");
        } else {
          button.disabled = false;
          text.textContent = "üíæ T·∫°o ng∆∞·ªùi d√πng";
          spinner.classList.add("d-none");
        }
      }

      // Download backup function
      async function downloadBackup() {
        try {
          showMainNotification("üîÑ ƒêang t·∫°o file backup...", "info");

          const response = await fetch("simple-api.php/api/backup");

          if (response.ok) {
            // Create download link
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = `users_backup_${new Date()
              .toISOString()
              .slice(0, 19)
              .replace(/:/g, "-")}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showMainNotification(
              "‚úÖ ƒê√£ t·∫£i xu·ªëng file backup th√†nh c√¥ng!",
              "success"
            );
          } else {
            throw new Error("Kh√¥ng th·ªÉ t·∫°o backup");
          }
        } catch (err) {
          console.error("Backup error:", err);
          showMainNotification(
            "‚ùå L·ªói khi t·∫°o backup: " + err.message,
            "danger"
          );
        }
      }

      // Show main page notification
      function showMainNotification(message, type = "info") {
        // Create notification element if it doesn't exist
        let notificationArea = document.getElementById("mainNotificationArea");
        if (!notificationArea) {
          notificationArea = document.createElement("div");
          notificationArea.id = "mainNotificationArea";
          notificationArea.style.position = "fixed";
          notificationArea.style.top = "20px";
          notificationArea.style.right = "20px";
          notificationArea.style.zIndex = "9999";
          notificationArea.style.maxWidth = "400px";
          document.body.appendChild(notificationArea);
        }

        // Create notification
        const notification = document.createElement("div");
        notification.className = `alert alert-${type} alert-dismissible fade show shadow`;
        notification.style.marginBottom = "10px";
        notification.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // Add to notification area
        notificationArea.appendChild(notification);

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 5000);
      }

      // Simple chart drawing
      function drawChart() {
        const canvas = document.getElementById("chartCanvas");
        const ctx = canvas.getContext("2d");

        // Simple bar chart
        ctx.fillStyle = "#667eea";
        ctx.fillRect(50, 150, 30, 50);
        ctx.fillRect(100, 120, 30, 80);
        ctx.fillRect(150, 100, 30, 100);
        ctx.fillRect(200, 130, 30, 70);
        ctx.fillRect(250, 90, 30, 110);

        ctx.fillStyle = "#000";
        ctx.font = "12px Arial";
        ctx.fillText("Jan", 55, 170);
        ctx.fillText("Feb", 105, 170);
        ctx.fillText("Mar", 155, 170);
        ctx.fillText("Apr", 205, 170);
        ctx.fillText("May", 255, 170);
      }

      // Update Dashboard Statistics
      async function updateDashboardStats() {
        try {
          const response = await fetch("simple-api.php/api/users");
          const result = await response.json();

          if (result.success) {
            const users = result.data;
            const totalUsers = users.length;

            // Count users by role
            const roleCounts = {
              Admin: 0,
              EVM_Staff: 0,
              SC_Staff: 0,
              SC_Technician: 0,
            };

            users.forEach((user) => {
              if (roleCounts.hasOwnProperty(user.role)) {
                roleCounts[user.role]++;
              }
            });

            // Update dashboard numbers
            const dashboardStats = document.querySelectorAll(".stat-number");
            if (dashboardStats.length >= 4) {
              dashboardStats[0].textContent = totalUsers; // Total users
              dashboardStats[1].textContent =
                roleCounts.SC_Staff + roleCounts.SC_Technician; // Service centers
              dashboardStats[2].textContent = Math.floor(totalUsers * 2.8); // Warranty requests (simulated)
              dashboardStats[3].textContent = "98%"; // Success rate
            }

            // Update reports section
            updateReportsSection(roleCounts, totalUsers);
          }
        } catch (error) {
          console.error("Error updating dashboard stats:", error);
        }
      }

      // Update Reports Section
      function updateReportsSection(roleCounts, totalUsers) {
        // Update user stats - find the first card with "B√°o c√°o ng∆∞·ªùi d√πng"
        const reportsSection = document.getElementById("reports-section");
        if (reportsSection) {
          const userStatsCard = reportsSection.querySelector(
            ".card .card-body ul"
          );
          if (userStatsCard) {
            userStatsCard.innerHTML = `
              <li>Admin: ${roleCounts.Admin} ng∆∞·ªùi</li>
              <li>EVM Staff: ${roleCounts.EVM_Staff} ng∆∞·ªùi</li>
              <li>SC Staff: ${roleCounts.SC_Staff} ng∆∞·ªùi</li>
              <li>Technician: ${roleCounts.SC_Technician} ng∆∞·ªùi</li>
            `;
          }

          // Update warranty stats (simulated based on user count)
          const warrantyCards = reportsSection.querySelectorAll(
            ".card .card-body ul"
          );
          if (warrantyCards.length > 1) {
            const pendingWarranties = Math.floor(totalUsers * 9);
            const completedWarranties = Math.floor(totalUsers * 237.8);
            const cancelledWarranties = Math.floor(totalUsers * 2.4);

            warrantyCards[1].innerHTML = `
              <li>ƒêang x·ª≠ l√Ω: ${pendingWarranties} y√™u c·∫ßu</li>
              <li>Ho√†n th√†nh: ${completedWarranties} y√™u c·∫ßu</li>
              <li>ƒê√£ h·ªßy: ${cancelledWarranties} y√™u c·∫ßu</li>
            `;
          }
        }
      }

      // Initialize page
      window.addEventListener("load", () => {
        checkSession();
        drawChart();
        updateDashboardStats();
        refreshReports(); // Load initial report data
      });

      // === REPORT FUNCTIONS ===

      // Refresh Reports Data v√† ƒë·ªìng b·ªô d·ªØ li·ªáu to√†n c·ª•c
      async function refreshReports() {
        try {
          const response = await fetch("simple-api.php/api/users");
          const result = await response.json();

          if (result.success) {
            globalUserData = result.data; // Store globally for consistency
            globalWarrantyData = generateSimulatedWarrantyData(
              globalUserData.length
            ); // Generate consistent warranty data

            updateReportsWithUserData(globalUserData);
            updateAdvancedAnalytics(globalUserData);

            showMainNotification(
              "üîÑ D·ªØ li·ªáu b√°o c√°o ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!",
              "info"
            );
          }
        } catch (error) {
          console.error("Error refreshing reports:", error);
          showMainNotification("‚ùå L·ªói khi t·∫£i d·ªØ li·ªáu b√°o c√°o", "danger");
        }
      }

      // Update Reports Section with Real User Data
      function updateReportsWithUserData(users) {
        const totalUsers = users.length;

        // Count users by role
        const roleCounts = {
          Admin: 0,
          EVM_Staff: 0,
          SC_Staff: 0,
          SC_Technician: 0,
        };

        users.forEach((user) => {
          if (roleCounts.hasOwnProperty(user.role)) {
            roleCounts[user.role]++;
          }
        });

        // Update UI elements
        document.getElementById("totalUsersCount").textContent = totalUsers;
        document.getElementById("userRoleStats").innerHTML = `
          <li>Admin: <span class="fw-bold text-danger">${roleCounts.Admin}</span> ng∆∞·ªùi</li>
          <li>EVM Staff: <span class="fw-bold text-info">${roleCounts.EVM_Staff}</span> ng∆∞·ªùi</li>
          <li>SC Staff: <span class="fw-bold text-warning">${roleCounts.SC_Staff}</span> ng∆∞·ªùi</li>
          <li>Technician: <span class="fw-bold text-success">${roleCounts.SC_Technician}</span> ng∆∞·ªùi</li>
        `;

        // Generate simulated warranty data based on users
        const pendingWarranties = Math.floor(totalUsers * 8.5);
        const completedWarranties = Math.floor(totalUsers * 189.5);
        const cancelledWarranties = Math.floor(totalUsers * 2.8);
        const totalWarranties =
          pendingWarranties + completedWarranties + cancelledWarranties;
        const successRate =
          totalWarranties > 0
            ? Math.round((completedWarranties / totalWarranties) * 100)
            : 0;

        document.getElementById("totalWarrantiesCount").textContent =
          totalWarranties;
        document.getElementById("warrantyStats").innerHTML = `
          <li>ƒêang x·ª≠ l√Ω: <span class="fw-bold text-warning">${pendingWarranties}</span> y√™u c·∫ßu</li>
          <li>Ho√†n th√†nh: <span class="fw-bold text-success">${completedWarranties}</span> y√™u c·∫ßu</li>
          <li>ƒê√£ h·ªßy: <span class="fw-bold text-danger">${cancelledWarranties}</span> y√™u c·∫ßu</li>
          <li>T·ª∑ l·ªá th√†nh c√¥ng: <span class="fw-bold text-primary">${successRate}%</span></li>
        `;
      }

      // Update Advanced Analytics
      function updateAdvancedAnalytics(users) {
        const totalUsers = users.length;

        // Simulate analytics based on user count
        const avgProcessingTime = Math.round(24 + totalUsers * 0.5); // hours
        const customerSatisfaction = Math.max(
          85,
          Math.min(98, 95 - totalUsers * 0.1)
        ); // percentage
        const monthlyCosts = (totalUsers * 245.5).toFixed(0); // dollars

        document.getElementById("avgProcessingTime").textContent =
          avgProcessingTime;
        document.getElementById("customerSatisfaction").textContent =
          Math.round(customerSatisfaction) + "%";
        document.getElementById("monthlyCosts").textContent =
          "$" + Number(monthlyCosts).toLocaleString();
      }

      // Central data store to ensure consistency
      let globalUserData = [];
      let globalWarrantyData = [];

      // Export User Report (Excel v·ªõi UTF-8 BOM)
      async function exportUserReport() {
        try {
          showMainNotification("üîÑ ƒêang t·∫°o b√°o c√°o ng∆∞·ªùi d√πng...", "info");

          const response = await fetch("simple-api.php/api/users");
          const result = await response.json();

          if (result.success) {
            globalUserData = result.data; // Store for consistency
            const csvContent = generateUserCSV(globalUserData);
            downloadFile(
              csvContent,
              `users_report_${new Date().toISOString().slice(0, 10)}.csv`,
              "text/csv"
            );
            showMainNotification(
              "‚úÖ ƒê√£ xu·∫•t b√°o c√°o ng∆∞·ªùi d√πng Excel th√†nh c√¥ng!",
              "success"
            );
          }
        } catch (error) {
          console.error("Export user report error:", error);
          showMainNotification("‚ùå L·ªói khi xu·∫•t b√°o c√°o ng∆∞·ªùi d√πng", "danger");
        }
      }

      // Generate CSV content for users with UTF-8 BOM
      function generateUserCSV(users) {
        const headers = [
          "ID",
          "T√™n ƒëƒÉng nh·∫≠p",
          "Vai tr√≤",
          "Email",
          "Ghi ch√∫",
          "Ng√†y t·∫°o",
          "Tr·∫°ng th√°i",
        ];

        // Add UTF-8 BOM for proper Vietnamese encoding
        let csv = "\ufeff"; // UTF-8 BOM
        csv += headers.join(",") + "\n";

        users.forEach((user) => {
          const row = [
            user.id,
            `"${user.username}"`,
            `"${user.role}"`,
            `"${user.email || ""}"`,
            `"${user.note || ""}"`,
            `"${user.created_at || ""}"`,
            `"${user.status || "active"}"`,
          ];
          csv += row.join(",") + "\n";
        });

        return csv;
      }

      // Show User Details Modal
      async function showUserDetails() {
        const modal = new bootstrap.Modal(
          document.getElementById("userDetailsModal")
        );
        modal.show();

        try {
          const response = await fetch("simple-api.php/api/users");
          const result = await response.json();

          if (result.success) {
            const users = result.data;
            const detailsHtml = generateUserDetailsHTML(users);
            document.getElementById("userDetailsContent").innerHTML =
              detailsHtml;
          }
        } catch (error) {
          document.getElementById("userDetailsContent").innerHTML =
            '<div class="alert alert-danger">‚ùå L·ªói khi t·∫£i chi ti·∫øt ng∆∞·ªùi d√πng</div>';
        }
      }

      // Generate User Details HTML
      function generateUserDetailsHTML(users) {
        const roleCounts = users.reduce((acc, user) => {
          acc[user.role] = (acc[user.role] || 0) + 1;
          return acc;
        }, {});

        let html = `
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                  <h6 class="mb-0">üìä Th·ªëng k√™ t·ªïng quan</h6>
                </div>
                <div class="card-body">
                  <p><strong>T·ªïng s·ªë ng∆∞·ªùi d√πng:</strong> ${users.length}</p>
                  <p><strong>Ng∆∞·ªùi d√πng ho·∫°t ƒë·ªông:</strong> ${
                    users.filter((u) => u.status !== "inactive").length
                  }</p>
                  <p><strong>Ng√†y t·∫°o b√°o c√°o:</strong> ${new Date().toLocaleDateString(
                    "vi-VN"
                  )}</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-success">
                <div class="card-header bg-success text-white">
                  <h6 class="mb-0">üë• Ph√¢n b·ªë vai tr√≤</h6>
                </div>
                <div class="card-body">
                  ${Object.entries(roleCounts)
                    .map(
                      ([role, count]) =>
                        `<p><strong>${role}:</strong> ${count} (${(
                          (count / users.length) *
                          100
                        ).toFixed(1)}%)</p>`
                    )
                    .join("")}
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">üìã Chi ti·∫øt t·ª´ng ng∆∞·ªùi d√πng</h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>T√™n ƒëƒÉng nh·∫≠p</th>
                      <th>Vai tr√≤</th>
                      <th>Email</th>
                      <th>Ng√†y t·∫°o</th>
                      <th>Tr·∫°ng th√°i</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${users
                      .map(
                        (user) => `
                      <tr>
                        <td>${user.id}</td>
                        <td><strong>${user.username}</strong></td>
                        <td><span class="badge bg-primary">${
                          user.role
                        }</span></td>
                        <td>${user.email || "-"}</td>
                        <td>${user.created_at || "-"}</td>
                        <td><span class="badge bg-success">Ho·∫°t ƒë·ªông</span></td>
                      </tr>
                    `
                      )
                      .join("")}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;

        return html;
      }

      // Export Warranty Report (Excel v·ªõi UTF-8 BOM)
      async function exportWarrantyReport() {
        showMainNotification("üîÑ ƒêang t·∫°o b√°o c√°o b·∫£o h√†nh Excel...", "info");

        try {
          // Use consistent user data
          let users = globalUserData;
          if (!users || users.length === 0) {
            const response = await fetch("simple-api.php/api/users");
            const result = await response.json();
            if (result.success) {
              users = result.data;
              globalUserData = users; // Store for consistency
            }
          }

          globalWarrantyData = generateSimulatedWarrantyData(users.length);
          const csvContent = generateWarrantyCSV(globalWarrantyData);
          downloadFile(
            csvContent,
            `warranty_report_${new Date().toISOString().slice(0, 10)}.csv`,
            "text/csv"
          );
          showMainNotification(
            "‚úÖ ƒê√£ xu·∫•t b√°o c√°o b·∫£o h√†nh Excel th√†nh c√¥ng!",
            "success"
          );
        } catch (error) {
          showMainNotification("‚ùå L·ªói khi xu·∫•t b√°o c√°o b·∫£o h√†nh", "danger");
        }
      }

      // Export Warranty PDF Report (Th·ª±c t·∫ø l√† HTML c√≥ th·ªÉ in th√†nh PDF)
      async function exportWarrantyPDFReport() {
        showMainNotification("üîÑ ƒêang t·∫°o b√°o c√°o b·∫£o h√†nh PDF...", "info");

        try {
          // Use consistent data
          let users = globalUserData;
          let warrantyData = globalWarrantyData;

          if (!users || users.length === 0) {
            const response = await fetch("simple-api.php/api/users");
            const result = await response.json();
            if (result.success) {
              users = result.data;
              globalUserData = users;
            }
          }

          if (!warrantyData || warrantyData.length === 0) {
            warrantyData = generateSimulatedWarrantyData(users.length);
            globalWarrantyData = warrantyData;
          }

          const pdfContent = generateWarrantyPDFContent(
            warrantyData,
            users.length
          );
          downloadFile(
            pdfContent,
            `warranty_report_${new Date().toISOString().slice(0, 10)}.html`,
            "text/html"
          );
          showMainNotification(
            "‚úÖ ƒê√£ t·∫°o b√°o c√°o PDF! M·ªü file HTML v√† in th√†nh PDF",
            "success"
          );
        } catch (error) {
          showMainNotification("‚ùå L·ªói khi t·∫°o b√°o c√°o PDF", "danger");
        }
      }

      // Show Warranty Details Modal
      function showWarrantyDetails() {
        const modal = new bootstrap.Modal(
          document.getElementById("warrantyDetailsModal")
        );
        modal.show();

        setTimeout(async () => {
          try {
            const response = await fetch("simple-api.php/api/users");
            const result = await response.json();

            if (result.success) {
              const warrantyData = generateSimulatedWarrantyData(
                result.data.length
              );
              const detailsHtml = generateWarrantyDetailsHTML(warrantyData);
              document.getElementById("warrantyDetailsContent").innerHTML =
                detailsHtml;
            }
          } catch (error) {
            document.getElementById("warrantyDetailsContent").innerHTML =
              '<div class="alert alert-danger">‚ùå L·ªói khi t·∫£i chi ti·∫øt b·∫£o h√†nh</div>';
          }
        }, 500);
      }

      // Generate simulated warranty data v·ªõi seed ƒë·ªÉ ƒë·∫£m b·∫£o consistent
      function generateSimulatedWarrantyData(userCount) {
        // Use consistent seed based on user count for reproducible data
        const seed = userCount * 123; // Consistent seed
        let rng = seedRandom(seed);

        const statuses = ["pending", "completed", "cancelled"];
        const priorities = ["low", "medium", "high", "urgent"];
        const types = [
          "Engine",
          "Battery",
          "Electronics",
          "Mechanical",
          "Software",
        ];

        const data = [];
        const totalWarranties = Math.floor(userCount * 15.8);

        for (let i = 1; i <= totalWarranties; i++) {
          const status = statuses[Math.floor(rng() * statuses.length)];
          const priority = priorities[Math.floor(rng() * priorities.length)];
          const type = types[Math.floor(rng() * types.length)];
          const createDate = new Date(
            2024,
            Math.floor(rng() * 11),
            Math.floor(rng() * 28) + 1
          );

          data.push({
            id: `WR-2024-${i.toString().padStart(3, "0")}`,
            type: type,
            status: status,
            priority: priority,
            created_date: createDate.toLocaleDateString("vi-VN"),
            customer: `Customer ${i}`,
            estimated_cost: Math.floor(rng() * 5000) + 500,
            processing_time: Math.floor(rng() * 72) + 6,
          });
        }

        return data;
      }

      // Simple seeded random number generator for consistency
      function seedRandom(seed) {
        let m = 0x80000000;
        let a = 1103515245;
        let c = 12345;
        let state = seed;

        return function () {
          state = (a * state + c) % m;
          return state / (m - 1);
        };
      }

      // Generate Warranty Details HTML
      function generateWarrantyDetailsHTML(warrantyData) {
        const statusCounts = warrantyData.reduce((acc, w) => {
          acc[w.status] = (acc[w.status] || 0) + 1;
          return acc;
        }, {});

        const priorityCounts = warrantyData.reduce((acc, w) => {
          acc[w.priority] = (acc[w.priority] || 0) + 1;
          return acc;
        }, {});

        const typeCounts = warrantyData.reduce((acc, w) => {
          acc[w.type] = (acc[w.type] || 0) + 1;
          return acc;
        }, {});

        const totalCost = warrantyData.reduce(
          (sum, w) => sum + w.estimated_cost,
          0
        );
        const avgProcessingTime =
          warrantyData.reduce((sum, w) => sum + w.processing_time, 0) /
          warrantyData.length;

        return `
          <div class="row mb-4">
            <div class="col-md-4">
              <div class="card border-info">
                <div class="card-header bg-info text-white">
                  <h6 class="mb-0">üìä Th·ªëng k√™ tr·∫°ng th√°i</h6>
                </div>
                <div class="card-body">
                  ${Object.entries(statusCounts)
                    .map(([status, count]) => {
                      const percentage = (
                        (count / warrantyData.length) *
                        100
                      ).toFixed(1);
                      const statusText =
                        {
                          pending: "ƒêang x·ª≠ l√Ω",
                          completed: "Ho√†n th√†nh",
                          cancelled: "ƒê√£ h·ªßy",
                        }[status] || status;
                      return `<p><strong>${statusText}:</strong> ${count} (${percentage}%)</p>`;
                    })
                    .join("")}
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-warning">
                <div class="card-header bg-warning text-white">
                  <h6 class="mb-0">‚ö° M·ª©c ƒë·ªô ∆∞u ti√™n</h6>
                </div>
                <div class="card-body">
                  ${Object.entries(priorityCounts)
                    .map(([priority, count]) => {
                      const priorityText =
                        {
                          low: "Th·∫•p",
                          medium: "Trung b√¨nh",
                          high: "Cao",
                          urgent: "Kh·∫©n c·∫•p",
                        }[priority] || priority;
                      return `<p><strong>${priorityText}:</strong> ${count}</p>`;
                    })
                    .join("")}
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card border-success">
                <div class="card-header bg-success text-white">
                  <h6 class="mb-0">üí∞ Th·ªëng k√™ chi ph√≠</h6>
                </div>
                <div class="card-body">
                  <p><strong>T·ªïng chi ph√≠:</strong> $${totalCost.toLocaleString()}</p>
                  <p><strong>Chi ph√≠ TB:</strong> $${Math.round(
                    totalCost / warrantyData.length
                  ).toLocaleString()}</p>
                  <p><strong>Th·ªùi gian x·ª≠ l√Ω TB:</strong> ${Math.round(
                    avgProcessingTime
                  )}h</p>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">üîß Ph√¢n lo·∫°i theo lo·∫°i l·ªói</h6>
            </div>
            <div class="card-body">
              <div class="row">
                ${Object.entries(typeCounts)
                  .map(
                    ([type, count]) => `
                  <div class="col-md-6 mb-2">
                    <div class="progress">
                      <div class="progress-bar" style="width: ${
                        (count / warrantyData.length) * 100
                      }%">
                        ${type}: ${count}
                      </div>
                    </div>
                  </div>
                `
                  )
                  .join("")}
              </div>
            </div>
          </div>

          <div class="card mt-3">
            <div class="card-header">
              <h6 class="mb-0">üìã Danh s√°ch y√™u c·∫ßu b·∫£o h√†nh (${
                warrantyData.length
              } y√™u c·∫ßu)</h6>
            </div>
            <div class="card-body">
              <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th>M√£ y√™u c·∫ßu</th>
                      <th>Lo·∫°i l·ªói</th>
                      <th>Tr·∫°ng th√°i</th>
                      <th>∆Øu ti√™n</th>
                      <th>Ng√†y t·∫°o</th>
                      <th>Chi ph√≠ ∆∞·ªõc t√≠nh</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${warrantyData
                      .slice(0, 50)
                      .map((warranty) => {
                        const statusBadge =
                          {
                            pending: "warning",
                            completed: "success",
                            cancelled: "danger",
                          }[warranty.status] || "secondary";

                        const priorityBadge =
                          {
                            low: "secondary",
                            medium: "info",
                            high: "warning",
                            urgent: "danger",
                          }[warranty.priority] || "secondary";

                        return `
                        <tr>
                          <td><strong>${warranty.id}</strong></td>
                          <td>${warranty.type}</td>
                          <td><span class="badge bg-${statusBadge}">${
                          warranty.status
                        }</span></td>
                          <td><span class="badge bg-${priorityBadge}">${
                          warranty.priority
                        }</span></td>
                          <td>${warranty.created_date}</td>
                          <td>$${warranty.estimated_cost.toLocaleString()}</td>
                        </tr>
                      `;
                      })
                      .join("")}
                    ${
                      warrantyData.length > 50
                        ? `<tr><td colspan="6" class="text-center text-muted"><em>... v√† ${
                            warrantyData.length - 50
                          } y√™u c·∫ßu kh√°c</em></td></tr>`
                        : ""
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      }

      // Generate Advanced Report
      async function generateAdvancedReport() {
        const modal = new bootstrap.Modal(
          document.getElementById("advancedReportModal")
        );
        modal.show();

        setTimeout(async () => {
          try {
            const response = await fetch("simple-api.php/api/users");
            const result = await response.json();

            if (result.success) {
              const users = result.data;
              const warrantyData = generateSimulatedWarrantyData(users.length);
              const reportHtml = generateAdvancedReportHTML(
                users,
                warrantyData
              );
              document.getElementById("advancedReportContent").innerHTML =
                reportHtml;
            }
          } catch (error) {
            document.getElementById("advancedReportContent").innerHTML =
              '<div class="alert alert-danger">‚ùå L·ªói khi t·∫°o b√°o c√°o chi ti·∫øt</div>';
          }
        }, 1000);
      }

      // Generate Advanced Report HTML
      function generateAdvancedReportHTML(users, warrantyData) {
        return `
          <div class="report-header mb-4 text-center">
            <h2>üìä B√ÅO C√ÅO T·ªîNG QUAN H·ªÜ TH·ªêNG OEM EV WARRANTY</h2>
            <p class="text-muted">Ng√†y t·∫°o: ${new Date().toLocaleDateString(
              "vi-VN"
            )} | Th·ªùi gian: ${new Date().toLocaleTimeString("vi-VN")}</p>
          </div>

          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card text-center bg-primary text-white">
                <div class="card-body">
                  <h3>${users.length}</h3>
                  <p class="mb-0">T·ªïng ng∆∞·ªùi d√πng</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center bg-success text-white">
                <div class="card-body">
                  <h3>${
                    warrantyData.filter((w) => w.status === "completed").length
                  }</h3>
                  <p class="mb-0">B·∫£o h√†nh ho√†n th√†nh</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center bg-warning text-white">
                <div class="card-body">
                  <h3>${
                    warrantyData.filter((w) => w.status === "pending").length
                  }</h3>
                  <p class="mb-0">ƒêang x·ª≠ l√Ω</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-center bg-info text-white">
                <div class="card-body">
                  <h3>${Math.round(
                    (warrantyData.filter((w) => w.status === "completed")
                      .length /
                      warrantyData.length) *
                      100
                  )}%</h3>
                  <p class="mb-0">T·ª∑ l·ªá th√†nh c√¥ng</p>
                </div>
              </div>
            </div>
          </div>

          ${generateUserDetailsHTML(users)}
          
          <hr class="my-4">
          
          ${generateWarrantyDetailsHTML(warrantyData)}
          
          <div class="mt-4 text-center">
            <small class="text-muted">
              B√°o c√°o ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông b·ªüi h·ªá th·ªëng OEM EV Warranty Management<br>
              ¬© 2024 OEM EV Warranty. All rights reserved.
            </small>
          </div>
        `;
      }

      // Utility Functions
      function downloadFile(content, fileName, contentType) {
        const blob = new Blob([content], { type: contentType });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = fileName;
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
      }

      function generateWarrantyCSV(warrantyData) {
        const headers = [
          "M√£ y√™u c·∫ßu",
          "Lo·∫°i l·ªói",
          "Tr·∫°ng th√°i",
          "∆Øu ti√™n",
          "Ng√†y t·∫°o",
          "Kh√°ch h√†ng",
          "Chi ph√≠ ∆∞·ªõc t√≠nh",
          "Th·ªùi gian x·ª≠ l√Ω (h)",
        ];

        // Add UTF-8 BOM for proper Vietnamese encoding
        let csv = "\ufeff"; // UTF-8 BOM
        csv += headers.join(",") + "\n";

        warrantyData.forEach((warranty) => {
          const row = [
            `"${warranty.id}"`,
            `"${warranty.type}"`,
            `"${warranty.status}"`,
            `"${warranty.priority}"`,
            `"${warranty.created_date}"`,
            `"${warranty.customer}"`,
            warranty.estimated_cost,
            warranty.processing_time,
          ];
          csv += row.join(",") + "\n";
        });

        return csv;
      }

      // Generate PDF Content for Warranty Report
      function generateWarrantyPDFContent(warrantyData, userCount) {
        const statusCounts = warrantyData.reduce((acc, w) => {
          acc[w.status] = (acc[w.status] || 0) + 1;
          return acc;
        }, {});

        const typeCounts = warrantyData.reduce((acc, w) => {
          acc[w.type] = (acc[w.type] || 0) + 1;
          return acc;
        }, {});

        const totalCost = warrantyData.reduce(
          (sum, w) => sum + w.estimated_cost,
          0
        );
        const avgProcessingTime =
          warrantyData.reduce((sum, w) => sum + w.processing_time, 0) /
          warrantyData.length;

        return `<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o B·∫£o H√†nh - OEM EV Warranty</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 20px; }
        .header { text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 30px; }
        .section { margin-bottom: 30px; page-break-inside: avoid; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-box { border: 2px solid #ddd; padding: 15px; text-align: center; border-radius: 8px; }
        .stat-number { font-size: 2em; font-weight: bold; color: #667eea; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .text-center { text-align: center; }
        .text-danger { color: #dc3545; }
        .text-success { color: #28a745; }
        .text-warning { color: #ffc107; }
        .text-info { color: #17a2b8; }
        @media print { 
            body { margin: 0; } 
            .section { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä B√ÅO C√ÅO B·∫¢O H√ÄNH OEM EV WARRANTY SYSTEM</h1>
        <p><strong>Ng√†y t·∫°o:</strong> ${new Date().toLocaleDateString(
          "vi-VN"
        )} | <strong>Th·ªùi gian:</strong> ${new Date().toLocaleTimeString(
          "vi-VN"
        )}</p>
        <p><strong>T·ªïng s·ªë ng∆∞·ªùi d√πng h·ªá th·ªëng:</strong> ${userCount} | <strong>T·ªïng y√™u c·∫ßu b·∫£o h√†nh:</strong> ${
          warrantyData.length
        }</p>
    </div>

    <div class="section">
        <h2>üìà T·ªïng Quan Th·ªëng K√™</h2>
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-number text-info">${warrantyData.length}</div>
                <div>T·ªïng Y√™u C·∫ßu</div>
            </div>
            <div class="stat-box">
                <div class="stat-number text-success">${
                  statusCounts.completed || 0
                }</div>
                <div>ƒê√£ Ho√†n Th√†nh</div>
            </div>
            <div class="stat-box">
                <div class="stat-number text-warning">${
                  statusCounts.pending || 0
                }</div>
                <div>ƒêang X·ª≠ L√Ω</div>
            </div>
            <div class="stat-box">
                <div class="stat-number text-danger">${
                  statusCounts.cancelled || 0
                }</div>
                <div>ƒê√£ H·ªßy</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üí∞ Ph√¢n T√≠ch Chi Ph√≠</h2>
        <table>
            <tr><th>Ch·ªâ S·ªë</th><th>Gi√° Tr·ªã</th></tr>
            <tr><td>T·ªïng Chi Ph√≠ ∆Ø·ªõc T√≠nh</td><td>$${totalCost.toLocaleString()}</td></tr>
            <tr><td>Chi Ph√≠ Trung B√¨nh</td><td>$${Math.round(
              totalCost / warrantyData.length
            ).toLocaleString()}</td></tr>
            <tr><td>Th·ªùi Gian X·ª≠ L√Ω TB</td><td>${Math.round(
              avgProcessingTime
            )} gi·ªù</td></tr>
            <tr><td>T·ª∑ L·ªá Th√†nh C√¥ng</td><td>${Math.round(
              ((statusCounts.completed || 0) / warrantyData.length) * 100
            )}%</td></tr>
        </table>
    </div>

    <div class="section">
        <h2>üîß Ph√¢n B·ªë Theo Lo·∫°i L·ªói</h2>
        <table>
            <tr><th>Lo·∫°i L·ªói</th><th>S·ªë L∆∞·ª£ng</th><th>T·ª∑ L·ªá (%)</th></tr>
            ${Object.entries(typeCounts)
              .map(
                ([type, count]) =>
                  `<tr><td>${type}</td><td>${count}</td><td>${(
                    (count / warrantyData.length) *
                    100
                  ).toFixed(1)}%</td></tr>`
              )
              .join("")}
        </table>
    </div>

    <div class="section">
        <h2>üìã Chi Ti·∫øt Y√™u C·∫ßu B·∫£o H√†nh (Top 50)</h2>
        <table>
            <tr>
                <th>M√£ YC</th>
                <th>Lo·∫°i L·ªói</th>
                <th>Tr·∫°ng Th√°i</th>
                <th>∆Øu Ti√™n</th>
                <th>Ng√†y T·∫°o</th>
                <th>Chi Ph√≠ ($)</th>
            </tr>
            ${warrantyData
              .slice(0, 50)
              .map(
                (warranty) => `
                <tr>
                    <td>${warranty.id}</td>
                    <td>${warranty.type}</td>
                    <td>${warranty.status}</td>
                    <td>${warranty.priority}</td>
                    <td>${warranty.created_date}</td>
                    <td>$${warranty.estimated_cost.toLocaleString()}</td>
                </tr>
            `
              )
              .join("")}
            ${
              warrantyData.length > 50
                ? `<tr><td colspan="6" class="text-center"><em>... v√† ${
                    warrantyData.length - 50
                  } y√™u c·∫ßu kh√°c</em></td></tr>`
                : ""
            }
        </table>
    </div>

    <div class="section text-center">
        <hr>
        <p><strong>B√°o c√°o ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông b·ªüi h·ªá th·ªëng OEM EV Warranty Management</strong></p>
        <p><em>¬© 2024 OEM EV Warranty. All rights reserved.</em></p>
        <p><small>ƒê·ªÉ in th√†nh PDF: Nh·∫•n Ctrl+P v√† ch·ªçn "Save as PDF" ho·∫∑c "Microsoft Print to PDF"</small></p>
    </div>
</body>
</html>`;
      }

      // Export all reports
      function exportAllReports() {
        showMainNotification("üîÑ ƒêang t·∫°o t·∫•t c·∫£ b√°o c√°o...", "info");
        setTimeout(() => {
          exportUserReport();
          setTimeout(() => {
            exportWarrantyReport();
            showMainNotification(
              "‚úÖ ƒê√£ xu·∫•t t·∫•t c·∫£ b√°o c√°o th√†nh c√¥ng!",
              "success"
            );
          }, 1000);
        }, 500);
      }

      // Export detailed reports v·ªõi d·ªØ li·ªáu ƒë·ªìng nh·∫•t
      function exportUserDetailReport() {
        // Use the same data that was shown in modal
        if (globalUserData && globalUserData.length > 0) {
          const csvContent = generateUserCSV(globalUserData);
          downloadFile(
            csvContent,
            `users_detailed_report_${new Date()
              .toISOString()
              .slice(0, 10)}.csv`,
            "text/csv"
          );
          showMainNotification(
            "‚úÖ ƒê√£ xu·∫•t b√°o c√°o ng∆∞·ªùi d√πng chi ti·∫øt!",
            "success"
          );
        } else {
          exportUserReport(); // Fallback
        }
      }

      function exportWarrantyDetailReport() {
        // Use the same data that was shown in modal
        if (globalWarrantyData && globalWarrantyData.length > 0) {
          const pdfContent = generateWarrantyPDFContent(
            globalWarrantyData,
            globalUserData?.length || 0
          );
          downloadFile(
            pdfContent,
            `warranty_detailed_report_${new Date()
              .toISOString()
              .slice(0, 10)}.html`,
            "text/html"
          );
          showMainNotification(
            "‚úÖ ƒê√£ t·∫°o b√°o c√°o b·∫£o h√†nh chi ti·∫øt PDF!",
            "success"
          );
        } else {
          exportWarrantyPDFReport(); // Fallback
        }
      }

      function exportAdvancedReportPDF() {
        showMainNotification("üîÑ ƒêang t·∫°o b√°o c√°o PDF chi ti·∫øt...", "info");
        setTimeout(async () => {
          try {
            // Ensure consistent data
            if (!globalUserData || globalUserData.length === 0) {
              const response = await fetch("simple-api.php/api/users");
              const result = await response.json();
              if (result.success) {
                globalUserData = result.data;
              }
            }

            if (!globalWarrantyData || globalWarrantyData.length === 0) {
              globalWarrantyData = generateSimulatedWarrantyData(
                globalUserData.length
              );
            }

            const reportHtml = generateAdvancedReportHTML(
              globalUserData,
              globalWarrantyData
            );
            const fullPDFContent = generateFullPDFReport(reportHtml);

            downloadFile(
              fullPDFContent,
              `advanced_report_${new Date().toISOString().slice(0, 10)}.html`,
              "text/html"
            );
            showMainNotification(
              "‚úÖ B√°o c√°o PDF t·ªïng h·ª£p ƒë√£ ƒë∆∞·ª£c t·∫°o!",
              "success"
            );
          } catch (error) {
            showMainNotification("‚ùå L·ªói khi t·∫°o b√°o c√°o PDF", "danger");
          }
        }, 1500);
      }

      function generateFullPDFReport(content) {
        return `<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o T·ªïng H·ª£p - OEM EV Warranty</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; margin: 20px; }
        .report-header { text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 30px; }
        .card { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; page-break-inside: avoid; }
        .card-header { background: #f8f9fa; padding: 15px; font-weight: bold; border-bottom: 1px solid #ddd; }
        .card-body { padding: 15px; }
        .row { display: flex; flex-wrap: wrap; margin: -10px; }
        .col-md-3 { flex: 0 0 25%; padding: 10px; }
        .col-md-6 { flex: 0 0 50%; padding: 10px; }
        .col-md-4 { flex: 0 0 33.33%; padding: 10px; }
        .col-md-12 { flex: 0 0 100%; padding: 10px; }
        .text-center { text-align: center; }
        .text-primary { color: #667eea; }
        .text-success { color: #28a745; }
        .text-warning { color: #ffc107; }
        .text-danger { color: #dc3545; }
        .text-info { color: #17a2b8; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.9em; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 0.8em; display: inline-block; }
        .bg-primary { background-color: #007bff; }
        .bg-success { background-color: #28a745; }
        .bg-warning { background-color: #ffc107; color: black; }
        .bg-danger { background-color: #dc3545; }
        .bg-secondary { background-color: #6c757d; }
        .progress { width: 100%; height: 20px; background-color: #e9ecef; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #007bff; color: white; text-align: center; line-height: 20px; }
        @media print { 
            body { margin: 0; font-size: 12px; } 
            .card { page-break-inside: avoid; margin-bottom: 15px; }
            .row { display: block; }
            .col-md-3, .col-md-4, .col-md-6, .col-md-12 { flex: none; width: auto; padding: 5px; }
        }
    </style>
</head>
<body>
    ${content}
    <div style="text-align: center; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
        <p><small><strong>H∆∞·ªõng d·∫´n:</strong> ƒê·ªÉ in th√†nh PDF: Nh·∫•n <kbd>Ctrl+P</kbd> v√† ch·ªçn "Save as PDF" ho·∫∑c "Microsoft Print to PDF"</small></p>
        <p><small><em>B√°o c√°o ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông b·ªüi h·ªá th·ªëng OEM EV Warranty Management System</em></small></p>
    </div>
</body>
</html>`;
      }

      function exportAnalytics() {
        showMainNotification("üîÑ ƒêang xu·∫•t d·ªØ li·ªáu ph√¢n t√≠ch...", "info");
        setTimeout(() => {
          // Generate analytics CSV
          const analyticsData = [
            ["Metric", "Value", "Unit", "Date"],
            [
              "Avg Processing Time",
              document.getElementById("avgProcessingTime").textContent,
              "hours",
              new Date().toLocaleDateString("vi-VN"),
            ],
            [
              "Customer Satisfaction",
              document.getElementById("customerSatisfaction").textContent,
              "percentage",
              new Date().toLocaleDateString("vi-VN"),
            ],
            [
              "Monthly Costs",
              document.getElementById("monthlyCosts").textContent,
              "USD",
              new Date().toLocaleDateString("vi-VN"),
            ],
          ];

          const csvContent = analyticsData
            .map((row) => row.join(","))
            .join("\n");
          downloadFile(
            csvContent,
            `analytics_${new Date().toISOString().slice(0, 10)}.csv`,
            "text/csv"
          );
          showMainNotification("‚úÖ D·ªØ li·ªáu ph√¢n t√≠ch ƒë√£ ƒë∆∞·ª£c xu·∫•t!", "success");
        }, 1000);
      }

      function printReport() {
        window.print();
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
