<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard - OEM EV Warranty</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .sidebar {
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        margin: 2px 0;
      }
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }
      .main-content {
        background: #f8f9fa;
        min-height: 100vh;
      }
      .stat-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }
      .stat-card:hover {
        transform: translateY(-2px);
      }
      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block sidebar p-3">
          <div class="text-center mb-4">
            <h4>üöó OEM EV Warranty</h4>
            <small id="welcomeMessage">Ch√†o m·ª´ng!</small>
          </div>

          <ul class="nav flex-column">
            <li class="nav-item">
              <a
                class="nav-link active"
                href="#dashboard"
                onclick="showSection('dashboard')"
              >
                üìä Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#users" onclick="showSection('users')">
                üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng
              </a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="#settings"
                onclick="showSection('settings')"
              >
                ‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng
              </a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="#reports"
                onclick="showSection('reports')"
              >
                üìà B√°o c√°o & Ph√¢n t√≠ch
              </a>
            </li>
          </ul>

          <div class="mt-auto pt-3">
            <a href="simple-login.html" class="nav-link"> üö™ ƒêƒÉng xu·∫•t </a>
          </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
          >
            <h1 class="h2" id="pageTitle">Dashboard</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary">
                  üìÑ Export
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-secondary"
                  onclick="updateDashboardStats()"
                >
                  üîÑ Refresh
                </button>
              </div>
            </div>
          </div>

          <!-- Dashboard Section -->
          <div id="dashboard-section" class="content-section">
            <div class="row mb-4">
              <div class="col-md-3 mb-3">
                <div class="stat-card">
                  <div class="stat-number">1</div>
                  <div class="text-muted">T·ªïng ng∆∞·ªùi d√πng</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="stat-card">
                  <div class="stat-number">23</div>
                  <div class="text-muted">Trung t√¢m d·ªãch v·ª•</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="stat-card">
                  <div class="stat-number">14</div>
                  <div class="text-muted">Y√™u c·∫ßu b·∫£o h√†nh</div>
                </div>
              </div>
              <div class="col-md-3 mb-3">
                <div class="stat-card">
                  <div class="stat-number">98%</div>
                  <div class="text-muted">T·ª∑ l·ªá ho√†n th√†nh</div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-8">
                <div class="card">
                  <div class="card-header">
                    <h5>üìä Bi·ªÉu ƒë·ªì th·ªëng k√™</h5>
                  </div>
                  <div class="card-body">
                    <canvas id="chartCanvas" width="400" height="200"></canvas>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <div class="card-header">
                    <h5>üìã Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h5>
                  </div>
                  <div class="card-body">
                    <div class="list-group list-group-flush">
                      <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                          <h6 class="mb-1">Ng∆∞·ªùi d√πng m·ªõi ƒëƒÉng k√Ω</h6>
                          <small>3 ph√∫t tr∆∞·ªõc</small>
                        </div>
                        <p class="mb-1">user123 ƒë√£ t·∫°o t√†i kho·∫£n m·ªõi</p>
                      </div>
                      <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                          <h6 class="mb-1">Y√™u c·∫ßu b·∫£o h√†nh m·ªõi</h6>
                          <small class="text-muted">15 ph√∫t tr∆∞·ªõc</small>
                        </div>
                        <p class="mb-1">Y√™u c·∫ßu #WR-2024-001 ƒë√£ ƒë∆∞·ª£c t·∫°o</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Users Section -->
          <div id="users-section" class="content-section" style="display: none">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h3>üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h3>
                <small class="text-muted">
                  <span id="dataInfo" class="badge bg-success ms-1"
                    >Database Ready</span
                  >
                </small>
              </div>
              <div class="btn-group">
                <button class="btn btn-success" onclick="showAddUserModal()">
                  ‚ûï Th√™m ng∆∞·ªùi d√πng
                </button>
                <button class="btn btn-primary" onclick="loadUsers()">
                  üîÑ T·∫£i danh s√°ch
                </button>
                <button
                  class="btn btn-outline-secondary btn-sm"
                  onclick="downloadBackup()"
                  title="T·∫£i xu·ªëng backup d·ªØ li·ªáu"
                >
                  üì• Backup
                </button>
              </div>
            </div>

            <div class="card">
              <div class="card-body">
                <div id="usersTable">
                  <p class="text-center text-muted">
                    <i class="fas fa-users fa-3x mb-3"></i><br />
                    Nh·∫•n "T·∫£i danh s√°ch" ƒë·ªÉ xem ng∆∞·ªùi d√πng ho·∫∑c "Th√™m ng∆∞·ªùi
                    d√πng" ƒë·ªÉ t·∫°o m·ªõi
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Add User Modal -->
          <div
            class="modal fade"
            id="addUserModal"
            tabindex="-1"
            aria-labelledby="addUserModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="addUserModalLabel">
                    ‚ûï Th√™m ng∆∞·ªùi d√πng m·ªõi
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <form id="addUserForm">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="newUsername" class="form-label"
                            >T√™n ƒëƒÉng nh·∫≠p *</label
                          >
                          <input
                            type="text"
                            class="form-control"
                            id="newUsername"
                            required
                            minlength="3"
                            maxlength="50"
                          />
                          <div class="form-text">
                            T·ªëi thi·ªÉu 3 k√Ω t·ª±, ch·ªâ ch·ª©a ch·ªØ v√† s·ªë
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="newEmail" class="form-label">Email</label>
                          <input
                            type="email"
                            class="form-control"
                            id="newEmail"
                          />
                          <div class="form-text">Email li√™n h·ªá (t√πy ch·ªçn)</div>
                        </div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="newPassword" class="form-label"
                            >M·∫≠t kh·∫©u *</label
                          >
                          <input
                            type="password"
                            class="form-control"
                            id="newPassword"
                            required
                            minlength="6"
                          />
                          <div class="form-text">T·ªëi thi·ªÉu 6 k√Ω t·ª±</div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="newRole" class="form-label"
                            >Vai tr√≤ *</label
                          >
                          <select class="form-select" id="newRole" required>
                            <option value="">-- Ch·ªçn vai tr√≤ --</option>
                            <option value="Admin">üîë Qu·∫£n tr·ªã vi√™n</option>
                            <option value="EVM_Staff">üè¢ Nh√¢n vi√™n EVM</option>
                            <option value="SC_Staff">
                              üîß Nh√¢n vi√™n trung t√¢m d·ªãch v·ª•
                            </option>
                            <option value="SC_Technician">
                              ‚öôÔ∏è K·ªπ thu·∫≠t vi√™n
                            </option>
                          </select>
                        </div>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label for="newNote" class="form-label">Ghi ch√∫</label>
                      <textarea
                        class="form-control"
                        id="newNote"
                        rows="2"
                        placeholder="Th√™m ghi ch√∫ v·ªÅ ng∆∞·ªùi d√πng n√†y..."
                      ></textarea>
                    </div>

                    <div id="addUserMessage"></div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    ‚ùå H·ªßy
                  </button>
                  <button
                    type="button"
                    class="btn btn-success"
                    onclick="addUser()"
                  >
                    <span id="addUserText">üíæ T·∫°o ng∆∞·ªùi d√πng</span>
                    <span
                      id="addUserSpinner"
                      class="spinner-border spinner-border-sm d-none ms-2"
                    ></span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- View User Modal -->
          <div
            class="modal fade"
            id="viewUserModal"
            tabindex="-1"
            aria-labelledby="viewUserModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="viewUserModalLabel">
                    üë§ Th√¥ng tin chi ti·∫øt ng∆∞·ªùi d√πng
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <div id="userDetails">
                    <p class="text-center">Loading...</p>
                  </div>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    ƒê√≥ng
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="editCurrentUser()"
                  >
                    ‚úèÔ∏è Ch·ªânh s·ª≠a
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Edit User Modal -->
          <div
            class="modal fade"
            id="editUserModal"
            tabindex="-1"
            aria-labelledby="editUserModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="editUserModalLabel">
                    ‚úèÔ∏è Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <div id="editUserMessage"></div>
                  <form id="editUserForm">
                    <input type="hidden" id="editUserId" />
                    <div class="mb-3">
                      <label for="editUsername" class="form-label"
                        >T√™n ƒëƒÉng nh·∫≠p</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="editUsername"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label for="editUserRole" class="form-label"
                        >Vai tr√≤</label
                      >
                      <select class="form-select" id="editUserRole" required>
                        <option value="">Ch·ªçn vai tr√≤...</option>
                        <option value="Admin">Admin</option>
                        <option value="EVM_Staff">EVM Staff</option>
                        <option value="SC_Staff">SC Staff</option>
                        <option value="SC_Technician">SC Technician</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="editUserEmail" class="form-label"
                        >Email</label
                      >
                      <input
                        type="email"
                        class="form-control"
                        id="editUserEmail"
                      />
                    </div>
                    <div class="mb-3">
                      <label for="editUserNote" class="form-label"
                        >Ghi ch√∫</label
                      >
                      <textarea
                        class="form-control"
                        id="editUserNote"
                        rows="2"
                      ></textarea>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    H·ªßy
                  </button>
                  <button
                    type="button"
                    class="btn btn-success"
                    onclick="updateUser()"
                  >
                    <span id="editUserText">üíæ C·∫≠p nh·∫≠t</span>
                    <div
                      id="editUserSpinner"
                      class="spinner-border spinner-border-sm ms-2"
                      style="display: none"
                      role="status"
                    >
                      <span class="visually-hidden">ƒêang x·ª≠ l√Ω...</span>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Settings Section -->
          <div
            id="settings-section"
            class="content-section"
            style="display: none"
          >
            <h3>‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</h3>
            <div class="card">
              <div class="card-body">
                <h5>C·∫•u h√¨nh chung</h5>
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">T√™n h·ªá th·ªëng</label>
                      <input
                        type="text"
                        class="form-control"
                        value="OEM EV Warranty Management"
                      />
                    </div>
                    <div class="form-group mb-3">
                      <label class="form-label">Email h·ªó tr·ª£</label>
                      <input
                        type="email"
                        class="form-control"
                        value="support@oemev.com"
                      />
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">M√∫i gi·ªù</label>
                      <select class="form-select">
                        <option selected>UTC+7 (Vietnam)</option>
                        <option>UTC+0 (GMT)</option>
                      </select>
                    </div>
                    <div class="form-group mb-3">
                      <label class="form-label">Ng√¥n ng·ªØ</label>
                      <select class="form-select">
                        <option selected>Ti·∫øng Vi·ªát</option>
                        <option>English</option>
                      </select>
                    </div>
                  </div>
                </div>
                <button class="btn btn-success">üíæ L∆∞u c√†i ƒë·∫∑t</button>
              </div>
            </div>
          </div>

          <!-- Reports Section -->
          <div
            id="reports-section"
            class="content-section"
            style="display: none"
          >
            <h3>üìà B√°o c√°o & Ph√¢n t√≠ch</h3>
            <div class="row">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h5>üìä B√°o c√°o ng∆∞·ªùi d√πng</h5>
                  </div>
                  <div class="card-body">
                    <p>Th·ªëng k√™ ng∆∞·ªùi d√πng theo vai tr√≤:</p>
                    <ul>
                      <li>Admin: 5 ng∆∞·ªùi</li>
                      <li>EVM Staff: 45 ng∆∞·ªùi</li>
                      <li>SC Staff: 120 ng∆∞·ªùi</li>
                      <li>Technician: 677 ng∆∞·ªùi</li>
                    </ul>
                    <button class="btn btn-primary btn-sm">
                      üìÑ Xu·∫•t b√°o c√°o
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h5>üîß B√°o c√°o b·∫£o h√†nh</h5>
                  </div>
                  <div class="card-body">
                    <p>Th·ªëng k√™ y√™u c·∫ßu b·∫£o h√†nh:</p>
                    <ul>
                      <li>ƒêang x·ª≠ l√Ω: 45 y√™u c·∫ßu</li>
                      <li>Ho√†n th√†nh: 1,189 y√™u c·∫ßu</li>
                      <li>ƒê√£ h·ªßy: 12 y√™u c·∫ßu</li>
                    </ul>
                    <button class="btn btn-success btn-sm">
                      üìä Xem chi ti·∫øt
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
      function showSection(sectionName) {
        // Hide all sections
        const sections = document.querySelectorAll(".content-section");
        sections.forEach((section) => (section.style.display = "none"));

        // Show selected section
        document.getElementById(sectionName + "-section").style.display =
          "block";

        // Update page title
        const titles = {
          dashboard: "Dashboard",
          users: "Qu·∫£n l√Ω ng∆∞·ªùi d√πng",
          settings: "C√†i ƒë·∫∑t h·ªá th·ªëng",
          reports: "B√°o c√°o & Ph√¢n t√≠ch",
        };
        document.getElementById("pageTitle").textContent = titles[sectionName];

        // Update active nav link
        const navLinks = document.querySelectorAll(".nav-link");
        navLinks.forEach((link) => link.classList.remove("active"));
        event.target.classList.add("active");
      }

      async function loadUsers() {
        const usersTable = document.getElementById("usersTable");
        usersTable.innerHTML = '<p class="text-center">üîÑ ƒêang t·∫£i...</p>';

        try {
          const response = await fetch("simple-api.php/api/users");
          const result = await response.json();

          if (result.success) {
            let tableHtml = `
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>T√™n ƒëƒÉng nh·∫≠p</th>
                                    <th>Vai tr√≤</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

            result.data.forEach((user) => {
              tableHtml += `
                            <tr>
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td><span class="badge bg-primary">${user.role}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info me-1" onclick="viewUser(${user.id}, '${user.username}', '${user.role}')">üëÅÔ∏è Xem</button>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser(${user.id})">‚úèÔ∏è S·ª≠a</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id}, '${user.username}')">üóëÔ∏è X√≥a</button>
                                </td>
                            </tr>
                        `;
            });

            tableHtml += "</tbody></table>";

            // Add data source info
            if (result.source) {
              tableHtml += `<div class="mt-3 text-end">
                <small class="text-muted">
                  üìä T·ªïng: ${result.total} ng∆∞·ªùi d√πng | 
                  üíæ Ngu·ªìn: ${
                    result.source === "file_storage"
                      ? "File JSON (L∆∞u vƒ©nh vi·ªÖn)"
                      : "Session (T·∫°m th·ªùi)"
                  }
                </small>
              </div>`;
            }

            usersTable.innerHTML = tableHtml;

            // Update data info badge
            const dataInfoBadge = document.getElementById("dataInfo");
            if (dataInfoBadge) {
              if (result.source === "file_storage") {
                dataInfoBadge.className = "badge bg-success ms-1";
                dataInfoBadge.textContent = `${result.total} users stored`;
              } else {
                dataInfoBadge.className = "badge bg-warning ms-1";
                dataInfoBadge.textContent = "Temporary storage";
              }
            }

            // Update dashboard stats after loading users
            updateDashboardStats();
          } else {
            usersTable.innerHTML =
              '<p class="text-danger">‚ùå Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng</p>';
          }
        } catch (err) {
          console.error("Load users error:", err);
          usersTable.innerHTML = '<p class="text-danger">‚ùå L·ªói k·∫øt n·ªëi</p>';
        }
      }

      // Check session and update welcome message
      async function checkSession() {
        try {
          const response = await fetch("simple-api.php/api/test");
          const result = await response.json();

          if (result.session) {
            document.getElementById(
              "welcomeMessage"
            ).textContent = `Ch√†o ${result.session.username}!`;
          }
        } catch (err) {
          console.error("Session check failed:", err);
        }
      }

      // Show Add User Modal
      function showAddUserModal() {
        // Reset form
        document.getElementById("addUserForm").reset();
        document.getElementById("addUserMessage").innerHTML = "";

        // Show modal
        const modal = new bootstrap.Modal(
          document.getElementById("addUserModal")
        );
        modal.show();

        // Focus on username field
        setTimeout(() => {
          document.getElementById("newUsername").focus();
        }, 500);
      }

      // Add User Function
      async function addUser() {
        const username = document.getElementById("newUsername").value.trim();
        const email = document.getElementById("newEmail").value.trim();
        const password = document.getElementById("newPassword").value.trim();
        const role = document.getElementById("newRole").value;
        const note = document.getElementById("newNote").value.trim();

        // Validation
        if (!username || username.length < 3) {
          showAddUserMessage("T√™n ƒëƒÉng nh·∫≠p ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±", "danger");
          return;
        }

        if (!password || password.length < 6) {
          showAddUserMessage("M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±", "danger");
          return;
        }

        if (!role) {
          showAddUserMessage("Vui l√≤ng ch·ªçn vai tr√≤", "danger");
          return;
        }

        // Set loading state
        setAddUserLoading(true);

        try {
          const userData = {
            username: username,
            password: password,
            role: role,
            email: email || null,
            note: note || null,
          };

          const response = await fetch("simple-api.php/api/users", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(userData),
          });

          const result = await response.json();

          if (result.success) {
            showAddUserMessage("‚úÖ T·∫°o ng∆∞·ªùi d√πng th√†nh c√¥ng!", "success");

            // Show success notification on main page
            showMainNotification(
              `‚úÖ ƒê√£ th√™m ng∆∞·ªùi d√πng "${username}" th√†nh c√¥ng!`,
              "success"
            );

            // Reload users immediately
            setTimeout(() => {
              loadUsers();
            }, 500);

            // Close modal after 2 seconds
            setTimeout(() => {
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addUserModal")
              );
              if (modal) {
                modal.hide();
              }
            }, 2000);
          } else {
            showAddUserMessage(
              result.error || "Kh√¥ng th·ªÉ t·∫°o ng∆∞·ªùi d√πng",
              "danger"
            );
          }
        } catch (err) {
          console.error("Add user error:", err);
          showAddUserMessage("‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.", "danger");
        } finally {
          setAddUserLoading(false);
        }
      }

      // View User Function
      function viewUser(id, username, role) {
        const userDetailsDiv = document.getElementById("userDetails");

        // Generate user details HTML
        userDetailsDiv.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <div class="card border-0 bg-light">
                <div class="card-body">
                  <h6 class="card-title text-primary">üÜî Th√¥ng tin c∆° b·∫£n</h6>
                  <p><strong>ID:</strong> ${id}</p>
                  <p><strong>T√™n ƒëƒÉng nh·∫≠p:</strong> ${username}</p>
                  <p><strong>Vai tr√≤:</strong> <span class="badge bg-primary">${role}</span></p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-0 bg-light">
                <div class="card-body">
                  <h6 class="card-title text-success">üìä Th·ªëng k√™ ho·∫°t ƒë·ªông</h6>
                  <p><strong>Ng√†y t·∫°o:</strong> ${new Date().toLocaleDateString(
                    "vi-VN"
                  )}</p>
                  <p><strong>L·∫ßn ƒëƒÉng nh·∫≠p cu·ªëi:</strong> H√¥m nay</p>
                  <p><strong>Tr·∫°ng th√°i:</strong> <span class="badge bg-success">Ho·∫°t ƒë·ªông</span></p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-12">
              <div class="card border-0 bg-light">
                <div class="card-body">
                  <h6 class="card-title text-info">üîí Quy·ªÅn h·∫°n</h6>
                  <div class="row">
                    ${getRolePermissions(role)}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        // Show modal
        const modal = new bootstrap.Modal(
          document.getElementById("viewUserModal")
        );
        modal.show();
      }

      // Get role permissions HTML
      function getRolePermissions(role) {
        const permissions = {
          Admin: [
            "üëë Qu·∫£n tr·ªã to√†n h·ªá th·ªëng",
            "üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng",
            "‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng",
            "üìä Xem b√°o c√°o",
          ],
          EVM_Staff: [
            "üìã Qu·∫£n l√Ω y√™u c·∫ßu b·∫£o h√†nh",
            "üìä Xem b√°o c√°o",
            "üìû H·ªó tr·ª£ kh√°ch h√†ng",
          ],
          SC_Staff: [
            "üîß X·ª≠ l√Ω y√™u c·∫ßu b·∫£o h√†nh",
            "üìù C·∫≠p nh·∫≠t tr·∫°ng th√°i",
            "üë• Qu·∫£n l√Ω k·ªπ thu·∫≠t vi√™n",
          ],
          SC_Technician: [
            "‚öôÔ∏è Th·ª±c hi·ªán s·ª≠a ch·ªØa",
            "üìù C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô",
            "üì∑ T·∫£i l√™n h√¨nh ·∫£nh",
          ],
        };

        const userPermissions = permissions[role] || [
          "Kh√¥ng c√≥ quy·ªÅn ƒë·∫∑c bi·ªát",
        ];

        return userPermissions
          .map(
            (permission) =>
              `<div class="col-md-6 mb-2">
            <span class="badge bg-outline-secondary">${permission}</span>
          </div>`
          )
          .join("");
      }

      // Edit User Function
      // Edit User Function
      async function editUser(id) {
        try {
          // Load current users to find the user data
          const response = await fetch("simple-api.php/api/users");
          const result = await response.json();

          if (result.success) {
            const user = result.data.find((u) => u.id == id);
            if (user) {
              // Fill the edit form with current user data
              document.getElementById("editUserId").value = user.id;
              document.getElementById("editUsername").value = user.username;
              document.getElementById("editUserRole").value = user.role;
              document.getElementById("editUserEmail").value = user.email || "";
              document.getElementById("editUserNote").value = user.note || "";

              // Clear any previous messages
              document.getElementById("editUserMessage").innerHTML = "";

              // Show the modal
              const editModal = new bootstrap.Modal(
                document.getElementById("editUserModal")
              );
              editModal.show();
            } else {
              showMainNotification("‚ùå Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng", "danger");
            }
          }
        } catch (err) {
          console.error("Load user error:", err);
          showMainNotification("‚ùå L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng", "danger");
        }
      }

      // Delete User Function
      async function deleteUser(id, username) {
        if (
          confirm(
            `‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng "${username}"?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`
          )
        ) {
          try {
            const response = await fetch(`simple-api.php/api/users/${id}`, {
              method: "DELETE",
            });
            const result = await response.json();

            if (result.success) {
              showMainNotification(`‚úÖ ${result.message}`, "success");

              // Reload users list
              setTimeout(() => {
                loadUsers();
              }, 500);
            } else {
              showMainNotification(
                `‚ùå ${result.error || "Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi d√πng"}`,
                "danger"
              );
            }
          } catch (err) {
            console.error("Delete user error:", err);
            showMainNotification("‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.", "danger");
          }
        }
      }

      // Update User Function
      async function updateUser() {
        const userId = document.getElementById("editUserId").value;
        const username = document.getElementById("editUsername").value.trim();
        const role = document.getElementById("editUserRole").value;
        const email = document.getElementById("editUserEmail").value.trim();
        const note = document.getElementById("editUserNote").value.trim();

        // Clear previous messages
        document.getElementById("editUserMessage").innerHTML = "";

        // Validate input
        if (!username) {
          showEditUserMessage("Vui l√≤ng nh·∫≠p t√™n ƒëƒÉng nh·∫≠p", "danger");
          return;
        }
        if (!role) {
          showEditUserMessage("Vui l√≤ng ch·ªçn vai tr√≤", "danger");
          return;
        }

        setEditUserLoading(true);

        try {
          const response = await fetch(`simple-api.php/api/users/${userId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: username,
              role: role,
              email: email,
              note: note,
            }),
          });

          const result = await response.json();

          if (result.success) {
            showEditUserMessage(`‚úÖ ${result.message}`, "success");

            // Reload users after delay
            setTimeout(() => {
              loadUsers();
            }, 500);

            // Close modal after 2 seconds
            setTimeout(() => {
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("editUserModal")
              );
              if (modal) {
                modal.hide();
              }
            }, 2000);
          } else {
            showEditUserMessage(
              result.error || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng",
              "danger"
            );
          }
        } catch (err) {
          console.error("Update user error:", err);
          showEditUserMessage("‚ùå L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.", "danger");
        } finally {
          setEditUserLoading(false);
        }
      }

      // Helper functions for Edit User Modal
      function showEditUserMessage(message, type = "danger") {
        const msgDiv = document.getElementById("editUserMessage");
        msgDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      }

      function setEditUserLoading(loading) {
        const button = document.querySelector("#editUserModal .btn-success");
        const text = document.getElementById("editUserText");
        const spinner = document.getElementById("editUserSpinner");

        if (loading) {
          button.disabled = true;
          text.textContent = "ƒêang x·ª≠ l√Ω...";
          spinner.style.display = "inline-block";
        } else {
          button.disabled = false;
          text.textContent = "üíæ C·∫≠p nh·∫≠t";
          spinner.style.display = "none";
        }
      }

      // Helper functions for Add User Modal
      function showAddUserMessage(message, type = "danger") {
        const msgDiv = document.getElementById("addUserMessage");
        msgDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      }

      function setAddUserLoading(loading) {
        const button = document.querySelector("#addUserModal .btn-success");
        const text = document.getElementById("addUserText");
        const spinner = document.getElementById("addUserSpinner");

        if (loading) {
          button.disabled = true;
          text.textContent = "‚è≥ ƒêang t·∫°o...";
          spinner.classList.remove("d-none");
        } else {
          button.disabled = false;
          text.textContent = "üíæ T·∫°o ng∆∞·ªùi d√πng";
          spinner.classList.add("d-none");
        }
      }

      // Download backup function
      async function downloadBackup() {
        try {
          showMainNotification("üîÑ ƒêang t·∫°o file backup...", "info");

          const response = await fetch("simple-api.php/api/backup");

          if (response.ok) {
            // Create download link
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            a.download = `users_backup_${new Date()
              .toISOString()
              .slice(0, 19)
              .replace(/:/g, "-")}.json`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showMainNotification(
              "‚úÖ ƒê√£ t·∫£i xu·ªëng file backup th√†nh c√¥ng!",
              "success"
            );
          } else {
            throw new Error("Kh√¥ng th·ªÉ t·∫°o backup");
          }
        } catch (err) {
          console.error("Backup error:", err);
          showMainNotification(
            "‚ùå L·ªói khi t·∫°o backup: " + err.message,
            "danger"
          );
        }
      }

      // Show main page notification
      function showMainNotification(message, type = "info") {
        // Create notification element if it doesn't exist
        let notificationArea = document.getElementById("mainNotificationArea");
        if (!notificationArea) {
          notificationArea = document.createElement("div");
          notificationArea.id = "mainNotificationArea";
          notificationArea.style.position = "fixed";
          notificationArea.style.top = "20px";
          notificationArea.style.right = "20px";
          notificationArea.style.zIndex = "9999";
          notificationArea.style.maxWidth = "400px";
          document.body.appendChild(notificationArea);
        }

        // Create notification
        const notification = document.createElement("div");
        notification.className = `alert alert-${type} alert-dismissible fade show shadow`;
        notification.style.marginBottom = "10px";
        notification.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // Add to notification area
        notificationArea.appendChild(notification);

        // Auto remove after 5 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 5000);
      }

      // Simple chart drawing
      function drawChart() {
        const canvas = document.getElementById("chartCanvas");
        const ctx = canvas.getContext("2d");

        // Simple bar chart
        ctx.fillStyle = "#667eea";
        ctx.fillRect(50, 150, 30, 50);
        ctx.fillRect(100, 120, 30, 80);
        ctx.fillRect(150, 100, 30, 100);
        ctx.fillRect(200, 130, 30, 70);
        ctx.fillRect(250, 90, 30, 110);

        ctx.fillStyle = "#000";
        ctx.font = "12px Arial";
        ctx.fillText("Jan", 55, 170);
        ctx.fillText("Feb", 105, 170);
        ctx.fillText("Mar", 155, 170);
        ctx.fillText("Apr", 205, 170);
        ctx.fillText("May", 255, 170);
      }

      // Update Dashboard Statistics
      async function updateDashboardStats() {
        try {
          const response = await fetch("simple-api.php/api/users");
          const result = await response.json();

          if (result.success) {
            const users = result.data;
            const totalUsers = users.length;

            // Count users by role
            const roleCounts = {
              Admin: 0,
              EVM_Staff: 0,
              SC_Staff: 0,
              SC_Technician: 0,
            };

            users.forEach((user) => {
              if (roleCounts.hasOwnProperty(user.role)) {
                roleCounts[user.role]++;
              }
            });

            // Update dashboard numbers
            const dashboardStats = document.querySelectorAll(".stat-number");
            if (dashboardStats.length >= 4) {
              dashboardStats[0].textContent = totalUsers; // Total users
              dashboardStats[1].textContent =
                roleCounts.SC_Staff + roleCounts.SC_Technician; // Service centers
              dashboardStats[2].textContent = Math.floor(totalUsers * 2.8); // Warranty requests (simulated)
              dashboardStats[3].textContent = "98%"; // Success rate
            }

            // Update reports section
            updateReportsSection(roleCounts, totalUsers);
          }
        } catch (error) {
          console.error("Error updating dashboard stats:", error);
        }
      }

      // Update Reports Section
      function updateReportsSection(roleCounts, totalUsers) {
        // Update user stats - find the first card with "B√°o c√°o ng∆∞·ªùi d√πng"
        const reportsSection = document.getElementById("reports-section");
        if (reportsSection) {
          const userStatsCard = reportsSection.querySelector(
            ".card .card-body ul"
          );
          if (userStatsCard) {
            userStatsCard.innerHTML = `
              <li>Admin: ${roleCounts.Admin} ng∆∞·ªùi</li>
              <li>EVM Staff: ${roleCounts.EVM_Staff} ng∆∞·ªùi</li>
              <li>SC Staff: ${roleCounts.SC_Staff} ng∆∞·ªùi</li>
              <li>Technician: ${roleCounts.SC_Technician} ng∆∞·ªùi</li>
            `;
          }

          // Update warranty stats (simulated based on user count)
          const warrantyCards = reportsSection.querySelectorAll(
            ".card .card-body ul"
          );
          if (warrantyCards.length > 1) {
            const pendingWarranties = Math.floor(totalUsers * 9);
            const completedWarranties = Math.floor(totalUsers * 237.8);
            const cancelledWarranties = Math.floor(totalUsers * 2.4);

            warrantyCards[1].innerHTML = `
              <li>ƒêang x·ª≠ l√Ω: ${pendingWarranties} y√™u c·∫ßu</li>
              <li>Ho√†n th√†nh: ${completedWarranties} y√™u c·∫ßu</li>
              <li>ƒê√£ h·ªßy: ${cancelledWarranties} y√™u c·∫ßu</li>
            `;
          }
        }
      }

      // Initialize page
      window.addEventListener("load", () => {
        checkSession();
        drawChart();
        updateDashboardStats();
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
