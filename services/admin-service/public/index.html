<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OEM EV Warranty - Admin</title>

    <!-- ✅ Bootstrap CSS -->
    <link rel="stylesheet" href="vendor/bootstrap/bootstrap.css">

    <!-- ✅ Custom Style -->
    <link rel="stylesheet" href="css/style.css">

    <!-- ✅ Chart.js -->
    <script src="chartjs/chart.js"></script>

    <!-- ✅ Font Awesome (icon) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

  <body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">OEM EV Warranty - Admin</a>
      <div class="d-flex align-items-center">
        <span class="navbar-text me-3" id="userInfo">Chào, <span id="currentUser">...</span></span>
        <div class="dropdown me-3">
          <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            Tài khoản
          </button>
          <ul class="dropdown-menu">
            <li><span class="dropdown-item-text">Vai trò: <span id="currentRole">...</span></span></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
          </ul>
        </div>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm" onclick="logout()">
          <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
        </button>
        
        <!-- Debug section (hidden in production) -->
        <div class="ms-3 d-none" id="debugSection">
          <span class="navbar-text me-2">Debug:</span>
          <select id="debug-role" class="form-select form-select-sm">
            <option>Admin</option>
            <option>SC_Staff</option>
            <option>SC_Technician</option>
            <option>EVM_Staff</option>
          </select>
        </div>
      </div>
    </div>
  </nav>    <div class="container my-4">
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <div class="card card-quick shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center kpi">
                <div class="kpi-icon bg-primary text-white rounded-circle me-3">
                  <!-- clipboard SVG -->
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M9 2h6v2h3v16a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h3V2h3z"
                      stroke="currentColor"
                      stroke-width="1.2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
                <div>
                  <div class="small-muted">Tổng yêu cầu</div>
                  <div class="kpi-value" id="total-claims">—</div>
                </div>
              </div>
              <div class="small-muted mt-2">Số lượng yêu cầu đã tiếp nhận</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card card-quick shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center kpi">
                <div class="kpi-icon bg-warning text-white rounded-circle me-3">
                  <!-- clock SVG -->
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <circle
                      cx="12"
                      cy="12"
                      r="9"
                      stroke="currentColor"
                      stroke-width="1.2"
                    />
                    <path
                      d="M12 7v6l4 2"
                      stroke="currentColor"
                      stroke-width="1.2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
                <div>
                  <div class="small-muted">Yêu cầu chờ</div>
                  <div class="kpi-value" id="pending-claims">—</div>
                </div>
              </div>
              <div class="small-muted mt-2">Yêu cầu đang chờ xử lý</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card card-quick shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center kpi">
                <div class="kpi-icon bg-success text-white rounded-circle me-3">
                  <!-- wallet SVG -->
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <rect
                      x="2"
                      y="7"
                      width="20"
                      height="14"
                      rx="2"
                      stroke="currentColor"
                      stroke-width="1.2"
                    />
                    <path
                      d="M16 11h.01"
                      stroke="currentColor"
                      stroke-width="1.6"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
                <div>
                  <div class="small-muted">Tổng chi phí</div>
                  <div class="kpi-value" id="total-cost">—</div>
                </div>
              </div>
              <div class="small-muted mt-2">Tổng chi phí (VNĐ)</div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-3">
          <div class="card card-quick shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-center kpi">
                <div class="kpi-icon bg-info text-white rounded-circle me-3">
                  <!-- trophy SVG -->
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M8 3v2a4 4 0 0 0 8 0V3"
                      stroke="currentColor"
                      stroke-width="1.2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                    <path
                      d="M3 7h18v2a5 5 0 0 1-5 5h-8A5 5 0 0 1 3 9V7z"
                      stroke="currentColor"
                      stroke-width="1.2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                </div>
                <div>
                  <div class="small-muted">Trung tâm hàng đầu</div>
                  <div class="kpi-value" id="top-center">—</div>
                </div>
              </div>
              <div class="small-muted mt-2">Theo số lượng hoàn thành</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4 g-4">
        <div class="col-12 col-lg-6">
          <div class="card chart-card shadow-sm">
            <div class="card-body">
              <h6>Chi phí theo tháng</h6>
              <canvas id="costChart"></canvas>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-6">
          <div class="card chart-card shadow-sm mb-3">
            <div class="card-body">
              <h6>Tỷ lệ lỗi theo loại</h6>
              <canvas id="failureChart"></canvas>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <h6>Hiệu suất trung tâm</h6>
              <canvas id="performanceChart" height="120"></canvas>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div
                class="d-flex justify-content-between align-items-center mb-3"
              >
                <h6 class="mb-0">Danh sách Trung tâm dịch vụ</h6>
                <div>
                  <button
                    class="btn btn-sm btn-primary me-2"
                    id="reloadCenters"
                  >
                    Tải lại
                  </button>
                </div>
              </div>

              <div class="table-responsive">
                <table
                  class="table table-striped table-hover"
                  id="centersTable"
                >
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Tên</th>
                      <th>Vị trí</th>
                      <th>Liên hệ</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Quản lý người dùng</h6>
                <div>
                  <div class="btn-group me-2" role="group">
                    <button type="button" class="btn btn-sm btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                      <i class="fas fa-download"></i> Export
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#" onclick="exportData('csv')">CSV</a></li>
                      <li><a class="dropdown-item" href="#" onclick="exportData('excel')">Excel</a></li>
                      <li><a class="dropdown-item" href="#" onclick="exportData('pdf')">PDF</a></li>
                    </ul>
                  </div>
                  <button class="btn btn-sm btn-primary me-2" id="reloadUsers">Tải lại</button>
                  <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#userModal" onclick="openCreateUserModal()">Thêm user</button>
                </div>
              </div>

              <!-- Danh sách users -->
              <div class="table-responsive">
                <table class="table table-striped table-hover" id="usersTable">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Tên đăng nhập</th>
                      <th>Vai trò</th>
                      <th>Ngày tạo</th>
                      <th>Thao tác</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

              <!-- Modal tạo/sửa user -->
              <div class="modal fade" id="userModal" tabindex="-1">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="userModalTitle">Thêm người dùng</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <form id="userForm">
                        <input type="hidden" id="userId" name="id">
                        <div class="mb-3">
                          <label for="username" class="form-label">Tên đăng nhập</label>
                          <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="mb-3">
                          <label for="password" class="form-label">Mật khẩu</label>
                          <input type="password" class="form-control" id="password" name="password">
                          <div class="form-text">Để trống nếu không muốn thay đổi mật khẩu</div>
                        </div>
                        <div class="mb-3">
                          <label for="role" class="form-label">Vai trò</label>
                          <select class="form-select" id="role" name="role" required>
                            <option value="SC_Staff">Nhân viên trung tâm</option>
                            <option value="SC_Technician">Kỹ thuật viên</option>
                            <option value="EVM_Staff">Nhân viên EVM</option>
                            <option value="Admin">Quản trị viên</option>
                          </select>
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                      <button type="button" class="btn btn-primary" onclick="saveUser()">Lưu</button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div id="userMsg" class="mt-2"></div>
            </div>
          </div>
        </div>
      </div>

      <footer class="pt-4 text-center small text-muted">
        © OEM EV Warranty
      </footer>
    </div>

    <script>
      const roleSelector = document.getElementById("debug-role");
      const baseOrigin = window.location.origin || "";
      
      // Auth state
      let currentUser = null;
      let useDebugMode = false;

      function api(path, opts = {}) {
        const headers = opts.headers || {};
        headers["Content-Type"] = headers["Content-Type"] || "application/json";
        
        // Add authentication headers
        if (useDebugMode && roleSelector) {
          headers["X-Role"] = roleSelector.value || "Admin";
        }
        
        opts.headers = headers;
        opts.credentials = 'same-origin'; // Include session cookies
        
        const url = baseOrigin === "null" || baseOrigin === "" ? path : baseOrigin + path;
        return fetch(url, opts).then(async (res) => {
          // If 403 Forbidden and not a login request, try to re-authenticate
          if (res.status === 403 && !path.includes('/api/login')) {
            console.log('API call forbidden, attempting re-authentication...');
            await autoLogin();
            // Retry the original request
            return fetch(url, opts).then(async (retryRes) => {
              const retryText = await retryRes.text();
              try {
                return JSON.parse(retryText);
              } catch (e) {
                return retryText;
              }
            });
          }
          
          const text = await res.text();
          try {
            return JSON.parse(text);
          } catch (e) {
            return text;
          }
        });
      }

      // Initialize auth state on page load
      async function initializeAuth() {
        try {
          const response = await api("/api/auth/status", { method: "GET" });
          console.log("Auth status response:", response);
          
          if (response.success && response.user) {
            currentUser = response.user;
            console.log("User authenticated:", currentUser);
            updateAuthUI(true);
            updateUserInfo();
          } else {
            console.log("User not authenticated, attempting auto-login...");
            // Try auto-login with admin credentials
            await autoLogin();
          }
        } catch (error) {
          console.error("Auth check failed:", error);
          // Try auto-login on error
          await autoLogin();
        }
      }

      async function autoLogin() {
        try {
          console.log("Attempting auto-login with admin credentials...");
          // Force a direct fetch call without recursion
          const loginResponse = await fetch("/api/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            credentials: 'same-origin',
            body: JSON.stringify({
              username: "admin",
              password: "admin123"
            })
          });
          
          const loginData = await loginResponse.json();
          
          if (loginResponse.ok && loginData && loginData.user) {
            currentUser = loginData.user;
            console.log("Auto-login successful:", currentUser);
            updateAuthUI(true);
            updateUserInfo();
            return true;
          } else {
            throw new Error("Auto-login failed: " + (loginData.message || loginResponse.statusText));
          }
        } catch (error) {
          console.error("Auto-login failed:", error);
          // Show login prompt in page instead of redirect
          showLoginPrompt();
        }
      }

      function showLoginPrompt() {
        const container = document.querySelector('.container');
        container.innerHTML = `
          <div class="alert alert-warning text-center mt-5">
            <h4>⚠️ Yêu cầu đăng nhập</h4>
            <p>Vui lòng đăng nhập với tài khoản admin</p>
            <button class="btn btn-primary" onclick="autoLogin()">Đăng nhập tự động (admin/admin123)</button>
          </div>
        `;
      }

      function updateUserInfo() {
        const currentUserSpan = document.getElementById("currentUser");
        const currentRoleSpan = document.getElementById("currentRole");
        
        if (currentUser) {
          if (currentUserSpan) {
            currentUserSpan.textContent = currentUser.username || "Unknown";
          }
          if (currentRoleSpan) {
            currentRoleSpan.textContent = getRoleText(currentUser.role) || currentUser.role || "Unknown";
          }
        }
      }

      function updateAuthUI(isAuthenticated) {
        const loginBtn = document.getElementById("loginBtn");
        const userDropdown = document.getElementById("userDropdown");
        const usernameSpan = document.getElementById("username");
        const debugModeToggle = document.getElementById("debugModeToggle");

        if (isAuthenticated) {
          if (loginBtn) loginBtn.style.display = "none";
          if (userDropdown) userDropdown.style.display = "block";
          if (usernameSpan) {
            usernameSpan.textContent = currentUser ? currentUser.username : (useDebugMode ? "Debug User" : "Unknown");
          }
        } else {
          if (loginBtn) loginBtn.style.display = "block";
          if (userDropdown) userDropdown.style.display = "none";
        }

        if (debugModeToggle) {
          debugModeToggle.style.display = useDebugMode ? "block" : "none";
        }
      }

      async function handleLogout() {
        try {
          const response = await api("/api/logout", { method: "POST" });
          if (response.success) {
            currentUser = null;
            updateAuthUI(false);
            window.location.href = "/login.html";
          }
        } catch (error) {
          console.error("Logout failed:", error);
        }
      }

      // Logout function called by navbar
      async function logout() {
        if (confirm("Bạn có chắc muốn đăng xuất?")) {
          await handleLogout();
        }
      }

      function toggleDebugMode() {
        useDebugMode = !useDebugMode;
        updateAuthUI(true);
        console.log("Debug mode:", useDebugMode ? "enabled" : "disabled");
      }

      async function loadSummary() {
        try {
          const data = await api("/api/dashboard/summary");
          document.getElementById("total-claims").innerText =
            data.total_warranties ?? "0";
          document.getElementById("pending-claims").innerText =
            Math.floor(data.total_warranties * 0.3) ?? "0"; // Simulated pending
          document.getElementById("total-cost").innerText =
            new Intl.NumberFormat("vi-VN").format(data.total_cost ?? 0);
          document.getElementById("top-center").innerText =
            data.top_service_centers && data.top_service_centers[0]
              ? data.top_service_centers[0].name
              : (data.total_service_centers > 0 ? "Service Center 1" : "-");
        } catch (err) {
          console.error(err);
        }
      }

      let costChart, failureChart, perfChart;
      async function loadCostChart() {
        try {
          const data = await api("/api/analytics/costs");
          const labels = data.map((d) => d.month);
          const values = data.map((d) => Number(d.total_cost ?? d.total ?? 0));
          const ctx = document.getElementById("costChart").getContext("2d");
          if (costChart) costChart.destroy();
          costChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Tổng chi phí",
                  data: values,
                  backgroundColor: "#0d6efd",
                },
              ],
            },
          });
        } catch (err) {
          console.error(err);
        }
      }

      async function loadFailureChart() {
        try {
          const data = await api("/api/analytics/failures");
          const labels = data.map(
            (d) => d.component_type || d.failure_type || "Unknown"
          );
          const values = data.map((d) =>
            Number(d.failure_count ?? d.count ?? 0)
          );
          const ctx = document.getElementById("failureChart").getContext("2d");
          if (failureChart) failureChart.destroy();
          failureChart = new Chart(ctx, {
            type: "pie",
            data: {
              labels,
              datasets: [
                {
                  data: values,
                  backgroundColor: [
                    "#dc3545",
                    "#0d6efd",
                    "#ffc107",
                    "#198754",
                    "#6c757d",
                  ],
                },
              ],
            },
          });
        } catch (err) {
          console.error(err);
        }
      }

      async function loadPerfChart() {
        try {
          const data = await api("/api/analytics/performance");
          const labels = data.map(
            (d) => d.service_center || d.name || d.service_center_name || "N/A"
          );
          const values = data.map((d) =>
            Number(d.total_claims ?? d.completed_tasks ?? 0)
          );
          const ctx = document
            .getElementById("performanceChart")
            .getContext("2d");
          if (perfChart) perfChart.destroy();
          perfChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Hoàn thành",
                  data: values,
                  backgroundColor: "#198754",
                },
              ],
            },
          });
        } catch (err) {
          console.error(err);
        }
      }

      async function loadCenters() {
        try {
          const rows = await api("/api/service-centers");
          const tbody = document.querySelector("#centersTable tbody");
          tbody.innerHTML = "";
          rows.forEach((r, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${i + 1}</td><td>${r.name}</td><td>${
              r.location
            }</td><td>${r.contact_info || ""}</td>`;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
        }
      }

      document
        .getElementById("reloadCenters")
        .addEventListener("click", loadCenters);
      document
        .getElementById("reloadUsers")
        .addEventListener("click", loadUsers);
      
      // Remove the old refreshAll event listener since we changed it to logout button

      // User management functions
      let currentUserId = null;

      async function loadUsers() {
        try {
          const users = await api("/api/users");
          const tbody = document.querySelector("#usersTable tbody");
          tbody.innerHTML = "";
          users.forEach((user, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${i + 1}</td>
              <td>${user.username}</td>
              <td><span class="badge bg-primary">${getRoleText(user.role)}</span></td>
              <td>${formatDate(user.created_at)}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">Sửa</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id}, '${user.username}')" ${user.username === 'admin' ? 'disabled' : ''}>Xóa</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
        }
      }

      function getRoleText(role) {
        const roles = {
          'Admin': 'Quản trị viên',
          'EVM_Staff': 'Nhân viên EVM',
          'SC_Staff': 'Nhân viên trung tâm',
          'SC_Technician': 'Kỹ thuật viên'
        };
        return roles[role] || role;
      }

      function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('vi-VN');
      }

      function openCreateUserModal() {
        currentUserId = null;
        document.getElementById('userModalTitle').textContent = 'Thêm người dùng';
        document.getElementById('userForm').reset();
        document.getElementById('password').required = true;
      }

      async function editUser(id) {
        try {
          const user = await api(`/api/users/${id}`);
          currentUserId = id;
          document.getElementById('userModalTitle').textContent = 'Sửa người dùng';
          document.getElementById('userId').value = user.id;
          document.getElementById('username').value = user.username;
          document.getElementById('role').value = user.role;
          document.getElementById('password').value = '';
          document.getElementById('password').required = false;
          
          // Show modal
          new bootstrap.Modal(document.getElementById('userModal')).show();
        } catch (err) {
          showUserMessage('Lỗi khi tải thông tin user: ' + err.message, 'danger');
        }
      }

      async function saveUser() {
        const form = document.getElementById('userForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        // Remove empty password
        if (!data.password) delete data.password;
        delete data.id; // Don't send ID in body

        try {
          let response;
          if (currentUserId) {
            // Update user
            response = await api(`/api/users/${currentUserId}`, {
              method: 'PUT',
              body: JSON.stringify(data)
            });
          } else {
            // Create user
            response = await api('/api/users', {
              method: 'POST',
              body: JSON.stringify(data)
            });
          }
          
          showUserMessage(response.message || 'Lưu thành công!', 'success');
          bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
          loadUsers();
        } catch (err) {
          showUserMessage('Lỗi: ' + (err.message || 'Không thể lưu'), 'danger');
        }
      }

      async function deleteUser(id, username) {
        if (!confirm(`Bạn có chắc muốn xóa user "${username}"?`)) return;
        
        try {
          const response = await api(`/api/users/${id}`, { method: 'DELETE' });
          showUserMessage(response.message || 'Xóa thành công!', 'success');
          loadUsers();
        } catch (err) {
          showUserMessage('Lỗi khi xóa: ' + (err.message || 'Không thể xóa'), 'danger');
        }
      }

      function showUserMessage(message, type = 'info') {
        const msgDiv = document.getElementById('userMsg');
        msgDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
        setTimeout(() => msgDiv.innerHTML = '', 5000);
      }

      // Export function
      async function exportData(format) {
        try {
          const response = await api('/api/reports/export', {
            method: 'POST',
            body: JSON.stringify({ format: format, type: 'users' })
          });

          if (format === 'csv') {
            // For CSV, the response will be the file content
            const blob = new Blob([response], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `users_export_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showUserMessage('Export CSV thành công!', 'success');
          } else {
            // For Excel and PDF, open in new window
            const exportUrl = `/api/reports/export`;
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = exportUrl;
            form.target = '_blank';
            
            const formatInput = document.createElement('input');
            formatInput.type = 'hidden';
            formatInput.name = 'format';
            formatInput.value = format;
            form.appendChild(formatInput);
            
            const typeInput = document.createElement('input');
            typeInput.type = 'hidden';
            typeInput.name = 'type';
            typeInput.value = 'users';
            form.appendChild(typeInput);
            
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
            
            showUserMessage(`Export ${format.toUpperCase()} đang được tạo...`, 'info');
          }
        } catch (err) {
          showUserMessage('Lỗi export: ' + (err.message || 'Không thể export'), 'danger');
        }
      }

      async function loadAll() {
        await Promise.all([
          loadSummary(),
          loadCostChart(),
          loadFailureChart(),
          loadPerfChart(),
          loadCenters(),
          loadUsers(),
        ]);
      }

      // initial load
      initializeAuth().then(() => {
        loadAll();
      });
    </script>

    <!-- ✅ Bootstrap JS -->
    <script src="vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <!-- Alternative: CDN Bootstrap if local files don't work -->
    <script>
      if (typeof bootstrap === 'undefined') {
        console.log('Loading Bootstrap from CDN...');
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js';
        document.head.appendChild(script);
      }
    </script>
  </body>
</html>
